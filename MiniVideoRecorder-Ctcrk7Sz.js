import{c as ee,a5 as te,K as ae,J as se,a6 as oe,I as ne,r as c,a7 as ie,a8 as re,e as le,k as F,w as v,o as de,L as ue,a9 as ce,aa as ve,ab as me,D as ge,l,m,n as f,x as L,s as i,G as g,N as S,Q as k,ac as C,F as z,t as q,H as G,v as H,ad as fe,ae as pe,O as he,af as Se,a3 as J,W as xe,ag as ye,ah as we,ai as be,_ as _e}from"./index-Bfpl-GJD.js";const I=w=>(we("data-v-38793bd3"),w=w(),be(),w),Ve={key:1},ke={class:"text-xs text-white select-none scroll-text"},Me={key:3,class:"w-16 text-justify text-slate-100"},Fe={key:4,class:"w-16 text-justify text-slate-100"},Ce=I(()=>f("div",{class:"text-xs text-center text-white select-none flex-nowrap"},"Processing video...",-1)),Ie=[Ce],Ne={class:"flex justify-center w-6"},Re=I(()=>f("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),Oe={class:"flex w-full justify-between items-center mt-4"},We=I(()=>f("span",null,"Record",-1)),De={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},Be=ee({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(w){const{showDialog:x}=te(),N=ae(),p=se(),o=oe(),s=ne(w).miniWidget,a=c(),{namessAvailableAbstractedStreams:_}=ie(o),R=c(),{isOutside:O}=re(R),W=c(!1),y=c(!1),K=le({interval:100}),d=c(),b=c(!1),D=c(0),n=c(),M=F(()=>n.value),B=()=>{N.videoLibraryVisibility=!0};v(()=>o.streamsCorrespondency,()=>d.value=void 0,{deep:!0}),de(async()=>{await V()}),ue(async()=>{Object.keys(s.value.options).length===0&&(s.value.options={internalStreamName:void 0}),a.value=s.value.options.internalStreamName,a.value&&(n.value=o.externalStreamId(a.value))}),v(a,()=>{s.value.options.internalStreamName=a.value,d.value=void 0}),v(()=>o.streamsCorrespondency,t=>{if(!n.value)return;const e=t.find(r=>r.externalId===n.value);e?a.value!==e.name&&(a.value=e.name):(a.value=void 0,n.value=void 0)},{deep:!0}),v(a,t=>{n.value=t?o.externalStreamId(t):void 0,s.value.options.internalStreamName=t,d.value=void 0});const V=async()=>{const t=(await o.videoStoringDB.keys()).filter(r=>o.isVideoFilename(r)).length,e=Object.keys(o.keysFailedUnprocessedVideos).length;D.value=t+e};function $(t){if(a.value=t,a.value===void 0){x({message:"No stream selected.",variant:"error"});return}if(_.value.includes(a.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw x({message:e,variant:"error"}),new Error(e)}const Q=async()=>{if(h.value){n.value&&o.stopRecording(n.value);return}if(!a.value){p.miniWidgetManagerVars(s.value.hash).configMenuOpen=!0;return}j()},j=()=>{var t;if(!n.value){x({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=o.getStreamData(n.value))!=null&&t.connected)){x({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}$(a.value),o.startRecording(n.value),p.miniWidgetManagerVars(s.value.hash).configMenuOpen=!1},h=F(()=>n.value?o.isRecording(n.value):!1),Y=F(()=>{var T,P,E,U;if(M.value===void 0)return"00:00:00";const t=(T=o.getStreamData(M.value))==null?void 0:T.timeRecordingStart;if(t===void 0)return"00:00:00";const e=ce({start:t,end:K.value}),r=((P=e.hours)==null?void 0:P.toFixed(0).length)===1?`0${e.hours}`:e.hours,u=((E=e.minutes)==null?void 0:E.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,Z=((U=e.seconds)==null?void 0:U.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${r}:${u}:${Z}`}),X=async t=>{$(t),d.value=void 0,y.value=!0;let e=0;const r=100,u=3e3;for(;y.value&&e<u;)y.value=d.value===void 0||!d.value.active,await ye(r),e+=r;if(y.value){x({message:"Could not load media stream.",variant:"error"});return}s.value.options.internalStreamName=t};let A;return p.isRealMiniWidget(s.value.hash)&&(A=setInterval(()=>{if(s.value.options.internalStreamName===void 0&&!_.value.isEmpty()&&(s.value.options.internalStreamName=_.value[0],a.value=s.value.options.internalStreamName),M.value!==void 0){const t=o.getMediaStream(s.value.options.internalStreamName);ve(t,d.value)||(d.value=t)}},1e3)),me(()=>clearInterval(A)),v(()=>o.areThereVideosProcessing,t=>{b.value=t,V()}),v(()=>o.keysFailedUnprocessedVideos,()=>V()),v(()=>W.value,async t=>{t===!1&&await V()}),v(h,()=>{if(!h.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(x({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const r=ge("FontAwesomeIcon");return l(),m(z,null,[f("div",{ref_key:"recorderWidget",ref:R,class:"flex justify-around px-2 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[b.value?(l(),m("div",Ve,[g(C,{class:"w-6 h-6 animate-spin",color:"white"},{default:S(()=>[k("mdi-loading")]),_:1})])):(l(),m("div",{key:0,class:L([{"blob red w-5 opacity-100 rounded-sm":h.value,"opacity-30 bg-red-400":i(O)&&!h.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=u=>Q())},null,2)),!h.value&&!b.value?(l(),m(z,{key:2},[a.value?(l(),m("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=u=>i(p).miniWidgetManagerVars(i(s).hash).configMenuOpen=!0)},[f("div",ke,q(a.value),1)])):(l(),G(r,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)):H("",!0),h.value&&!b.value?(l(),m("div",Me,q(Y.value),1)):b.value?(l(),m("div",Fe,Ie)):H("",!0),f("div",Ne,[g(fe,{vertical:"",class:"h-6 ml-1"}),g(pe,{color:"info",content:D.value,dot:i(O)||W.value,class:"cursor-pointer",onClick:B},{default:S(()=>[g(C,{class:"w-6 h-6 ml-1 text-slate-100",onClick:B},{default:S(()=>[k(" mdi-video-box ")]),_:1})]),_:1},8,["content","dot"])])],512),g(xe,{modelValue:i(p).miniWidgetManagerVars(i(s).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=u=>i(p).miniWidgetManagerVars(i(s).hash).configMenuOpen=u),width:"auto"},{default:S(()=>[f("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:he(i(N).globalGlassMenuStyles)},[Re,g(Se,{"model-value":a.value,label:"Stream name",items:i(_),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":X},null,8,["model-value","items"]),f("div",Oe,[g(J,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=u=>i(p).miniWidgetManagerVars(i(s).hash).configMenuOpen=!1)},{default:S(()=>[k(" Close ")]),_:1}),g(J,{class:L(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":y.value}]),size:"large",onClick:j},{default:S(()=>[We,y.value?(l(),G(C,{key:0,class:"m-2 animate-spin"},{default:S(()=>[k("mdi-loading")]),_:1})):(l(),m("div",De))]),_:1},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),Ae=_e(Be,[["__scopeId","data-v-38793bd3"]]);export{Ae as default};
