import{c as ue,al as de,r as b,ca as ge,w as Q,o as ye,j as be,aq as ve,m as y,n as v,p as u,_ as ce,cb as Se,bF as he,z as s,h as w,t as Ve,R as we,e as xe,am as ke,W as Fe,q as d,s as te,v as E,B as C,E as h,a3 as Ne,G as L,ae as Ie,F as ae,C as ie,V as le,aK as Ce,Y as $e,x as Pe,Z as Re,$ as De,as as re,H as Z,a6 as Le}from"./index-BLj2N6pH.js";const _e={class:"canvas-container"},Me=["width","height"],J=100,Te=60,ze=ue({__name:"VideoPlayerStatsForNerds",props:{width:{type:Number,default:130},height:{type:Number,default:200},updateInterval:{type:Number,default:20},streamName:{type:String,default:""}},setup(_){const X=de(),i=_,M=b(null),r=b([]),$=b([]),a=b([]);let n=null,F=null,m=0,f=0,P=0,x=0,c=0,S=0,p=0,H=0,T=!1,j=0,O=0,W=0,q=0,G=0,R=0,Y=0,z=0,U=1e3,o=30,e=10,l=120;function N(k,t){return k/t*Te}function oe(){const t=M.value.getContext("2d"),{width:g,height:I}=i;t.clearRect(0,0,g,I);function A(D,ee,fe){t.strokeStyle=ee,t.lineWidth=1,t.beginPath();for(let B=0;B<D.length;B++){const se=B/(J-1)*g,ne=I-N(D[B],fe);B===0?t.moveTo(se,ne):t.lineTo(se,ne)}t.stroke()}A($.value,"rgb(255, 165, 0)",U),A(r.value,"rgb(0, 255, 0)",o),A(a.value,"rgb(255, 0, 0)",e);const V=T?"red":"white",pe=[{label:"Stream",value:i.streamName,color:V},{label:"Size",value:z?`${z}p`:"N/A",color:V},{label:"Packets Lost",value:`${f} (${G.toFixed(0)}%)`,color:V},{label:"Frame drops",value:q,color:V},{label:"Nack",value:c,color:V},{label:"Pli",value:S,color:V},{label:"Fir",value:p,color:V},{label:"Processing ",value:`${j.toFixed(0)}ms`,color:V},{label:"Freezes",value:`${O}(${W.toFixed(1)}s)`,color:V},{label:"Bitrate",value:`${m.toFixed(0)}kbps`,color:"rgb(255, 165, 0)"},{label:"FPS",value:R.toFixed(2),color:"rgb(0, 255, 0)"}];t.font="10px Arial",pe.forEach((D,ee)=>{t.fillStyle=D.color,t.fillText(`${D.label}: ${D.value}`,5,12+ee*12)}),n=requestAnimationFrame(oe)}const K=new ge({getStatsInterval:100});function me(){r.value.push(R),$.value.push(m),a.value.push(Math.min(Y,e)),r.value.length>J&&r.value.shift(),$.value.length>J&&$.value.shift(),a.value.length>J&&a.value.shift(),U=Math.max(U,...$.value),o=Math.max(o,...r.value),o=Math.min(o,l)}return Q(X.activeStreams,k=>{Object.keys(k).forEach(t=>{var I;if(t!==i.streamName)return;const g=(I=k[t])==null?void 0:I.webRtcManager.session;!g||!g.peerConnection||K.peersToMonitor[g.consumerId]||K.addConnection({pc:g.peerConnection,peerId:g.consumerId,connectionId:g.id,remote:!1})})}),ye(()=>{F=setInterval(me,i.updateInterval),oe(),K.on("stats",k=>{try{const t=k.data.video.inbound[0];if(t===void 0)return;if(T=t.bitrate===0,!isNaN(t.bitrate)){const A=t.bitrate/1e3;m=m*.8+A*.2}Y=t.packetsLost-f,f=t.packetsLost,c=t.nackCount,S=t.pliCount,p=t.firCount,P=t.packetsReceived;let g=t.totalProcessingDelay-x,I=t.framesReceived-H;j=1e3*g/I,H=t.framesReceived,x=t.totalProcessingDelay,G=f/(f+P)*100,O=t.freezeCount,W=t.totalFreezesDuration,q=t.framesDropped,R=t.framesPerSecond??0,z=t.frameHeight}catch(t){console.error(t)}})}),be(()=>{clearInterval(F),cancelAnimationFrame(n)}),ve(()=>{K.destroy()}),(k,t)=>(v(),y("div",_e,[u("canvas",{ref_key:"canvasRef",ref:M,width:_.width,height:_.height},null,8,Me)]))}}),Ue=ce(ze,[["__scopeId","data-v-4a8ba759"]]),Ae=Se("v-banner-text"),Be={ref:"videoWidget",class:"video-widget"},Ee={key:1,class:"no-video-alert"},He={key:2,class:"no-video-alert"},je={key:0,class:"loading-overlay"},Oe={key:0,class:"success-icon mb-4"},We={class:"loading-text"},qe={key:2,class:"verbose-status"},Ge={class:"status-line"},Ye={class:"status-line"},Ke={class:"flex-wrap justify-center d-flex ga-5"},Ze=ue({__name:"VideoPlayer",props:{widget:{}},setup(_){he(o=>({"071017e7":W.value,"1b383503":s(a).options.videoFitStyle}));const X=we(),i=de(),M=xe(),{namessAvailableAbstractedStreams:r}=ke(i),a=Ve(_).widget,n=b(),F=b(),m=b(),f=b(!1),P=b(!1),x=b(!1),c=b(!1);let S=null;Fe(()=>{const o={videoFitStyle:"cover",flipHorizontally:!1,flipVertically:!1,rotationAngle:0,statsForNerds:!1,internalStreamName:void 0,showVerboseLoading:!1};a.value.options={...o,...a.value.options},n.value=a.value.options.internalStreamName});const p=w(()=>n.value?i.externalStreamId(n.value):void 0);Q(()=>i.streamsCorrespondency,()=>{if(m.value=void 0,!n.value)return;const o=i.externalStreamId(n.value);if(!o)return;const e=i.streamsCorrespondency.find(N=>N.externalId===o);if(!e)return;const l=e.name;n.value!==l&&(n.value=l,a.value.options.internalStreamName=l)},{deep:!0});const H=setInterval(()=>{var o;if(a.value.options.internalStreamName===void 0&&!r.value.isEmpty()&&(a.value.options.internalStreamName=r.value[0],n.value=a.value.options.internalStreamName),p.value!==void 0){const e=i.getMediaStream(p.value);e!==m.value&&(m.value=e);const l=((o=i.getStreamData(p.value))==null?void 0:o.connected)??!1;l!==f.value&&(f.value=l)}if(!r.value.isEmpty()&&!r.value.includes(n.value)){if(i.lastRenamedStreamName!==""){n.value=i.lastRenamedStreamName;return}n.value=r.value[0]}},1e3);ve(()=>{clearInterval(H),S&&clearTimeout(S)}),Q(n,()=>{a.value.options.internalStreamName=n.value,m.value=void 0,x.value=!1,c.value=!1,S&&clearTimeout(S)}),Q(m,()=>{if(!F.value||!m.value){x.value=!1,c.value=!1;return}F.value.srcObject=m.value,F.value.play().then(()=>{console.log("[VideoPlayer] Stream is playing"),x.value=!0,c.value=!0,S&&clearTimeout(S),S=setTimeout(()=>{c.value=!1},1e3)}).catch(o=>{const e=`Failed to play stream. Reason: ${o}`;console.error(`[VideoPlayer] ${e}`),x.value=!1,c.value=!1})});const T=o=>{a.value.options.rotationAngle+=o},j=w(()=>`scale(${a.value.options.flipHorizontally?-1:1}, ${a.value.options.flipVertically?-1:1})`),O=w(()=>`rotate(${a.value.options.rotationAngle??0}deg)`),W=w(()=>`${j.value} ${O.value}`),q=w(()=>{var o;return p.value===void 0?"Unknown.":((o=i.getStreamData(p.value))==null?void 0:o.webRtcManager.signallerStatus)??"Unknown."}),G=w(()=>{var e;if(p.value===void 0)return"Unknown.";const o=i.availableIceIps;return!o.isEmpty()&&!o.find(l=>i.allowedIceIps.includes(l))?`Stream is coming from IPs [${o.join(", ")}], which are not in the list of allowed sources
      [${i.allowedIceIps.join(", ")}].\\n Please check your configuration.`:((e=i.getStreamData(p.value))==null?void 0:e.webRtcManager.streamStatus)??"Unknown."}),R=w(()=>a.value.options.showVerboseLoading||P.value),Y=w(()=>n.value===void 0||!r.value.includes(n.value)?!1:c.value?!0:!x.value),z=w(()=>{const o=n.value?`'${n.value} (${p.value??"unknown"})'`:"";return c.value?"Stream loaded":(f.value?"Loading":"Connecting to")+` stream ${o}`}),U=()=>{P.value=!P.value};return(o,e)=>(v(),y(ae,null,[u("div",Be,[s(a).options.statsForNerds?(v(),te(Ue,{key:0,"stream-name":p.value},null,8,["stream-name"])):E("",!0),n.value===void 0?(v(),y("div",Ee,e[9]||(e[9]=[u("span",null,"No video stream selected.",-1)]))):!s(r).isEmpty()&&!s(r).includes(n.value)?(v(),y("div",He,[u("p",null,'The selected stream "'+C(n.value)+'" is not available.',1),u("p",null,"Available ones are: "+C(s(r).map(l=>`"${l}"`).join(", "))+".",1),e[10]||(e[10]=u("br",null,null,-1)),e[11]||(e[11]=u("p",null," This can happen if you changed vehicles and the stream name in the new one is different from the former, or if the source is not available at all. ",-1)),e[12]||(e[12]=u("br",null,null,-1)),e[13]||(e[13]=u("p",null," Please open this video player configuration and select a new stream from the ones available, or check your source for issues. ",-1))])):E("",!0),d(Ce,{name:"loading-complete"},{default:h(()=>[Y.value?(v(),y("div",je,[c.value?(v(),y("div",Oe,[d(Ne,{size:"48",color:"white"},{default:h(()=>e[14]||(e[14]=[L("mdi-check-circle")])),_:1,__:[14]})])):(v(),te(Ie,{key:1,indeterminate:"",color:"white",size:"48",width:"3",class:"mb-4"})),u("p",We,C(z.value),1),R.value&&!f.value&&!c.value?(v(),y("div",qe,[u("p",Ge,[e[15]||(e[15]=u("span",{class:"status-label"},"Server: ",-1)),(v(!0),y(ae,null,ie(q.value.toString().split("\\n"),(l,N)=>(v(),y("span",{key:"server-"+N},C(l),1))),128))]),u("p",Ye,[e[16]||(e[16]=u("span",{class:"status-label"},"Stream: ",-1)),(v(!0),y(ae,null,ie(G.value.toString().split("\\n"),(l,N)=>(v(),y("span",{key:"stream-"+N},C(l),1))),128))])])):E("",!0),!f.value&&!c.value?(v(),te(le,{key:3,variant:"text",size:"small",class:"mt-3 toggle-details-btn",onClick:U},{default:h(()=>[L(C(R.value?"Hide details":"Show details"),1)]),_:1})):E("",!0)])):E("",!0)]),_:1}),u("video",{id:"mainDisplayStream",ref_key:"videoElement",ref:F,muted:"",autoplay:"",playsinline:"",disablePictureInPicture:""}," Your browser does not support the video tag. ",512)],512),d(Le,{modelValue:s(M).widgetManagerVars(s(a).hash).configMenuOpen,"onUpdate:modelValue":e[8]||(e[8]=l=>s(M).widgetManagerVars(s(a).hash).configMenuOpen=l),width:"auto"},{default:h(()=>[d($e,{class:"pa-4 text-white",style:Pe([{"border-radius":"15px"},s(X).globalGlassMenuStyles])},{default:h(()=>[d(Re,{class:"text-center"},{default:h(()=>e[17]||(e[17]=[L("Video widget config")])),_:1,__:[17]}),d(De,{class:"flex flex-col gap-y-4"},{default:h(()=>[d(re,{modelValue:n.value,"onUpdate:modelValue":e[0]||(e[0]=l=>n.value=l),label:"Stream name",class:"my-3",items:s(r),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue","items"]),d(re,{modelValue:s(a).options.videoFitStyle,"onUpdate:modelValue":e[1]||(e[1]=l=>s(a).options.videoFitStyle=l),label:"Fit style",class:"my-3",items:["cover","fill","contain"],"item-title":"style",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue"]),d(Ae,null,{default:h(()=>[L('Saved stream name: "'+C(s(a).options.internalStreamName)+'"',1)]),_:1}),d(Z,{modelValue:s(a).options.flipHorizontally,"onUpdate:modelValue":e[2]||(e[2]=l=>s(a).options.flipHorizontally=l),class:"my-1",label:"Flip horizontally",color:s(a).options.flipHorizontally?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),d(Z,{modelValue:s(a).options.flipVertically,"onUpdate:modelValue":e[3]||(e[3]=l=>s(a).options.flipVertically=l),class:"my-1",label:"Flip vertically",color:s(a).options.flipVertically?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),d(Z,{modelValue:s(a).options.statsForNerds,"onUpdate:modelValue":e[4]||(e[4]=l=>s(a).options.statsForNerds=l),class:"my-1",label:"Stats for nerds",color:s(a).options.statsForNerds?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),d(Z,{modelValue:s(a).options.showVerboseLoading,"onUpdate:modelValue":e[5]||(e[5]=l=>s(a).options.showVerboseLoading=l),class:"my-1",label:"Verbose loading status",color:s(a).options.showVerboseLoading?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),u("div",Ke,[d(le,{"prepend-icon":"mdi-file-rotate-left",variant:"outlined",onClick:e[6]||(e[6]=l=>T(-90))},{default:h(()=>e[18]||(e[18]=[L(" Rotate Left")])),_:1,__:[18]}),d(le,{"prepend-icon":"mdi-file-rotate-right",variant:"outlined",onClick:e[7]||(e[7]=l=>T(90))},{default:h(()=>e[19]||(e[19]=[L(" Rotate Right")])),_:1,__:[19]})])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"])],64))}}),Qe=ce(Ze,[["__scopeId","data-v-6fb61955"]]);export{Qe as default};
