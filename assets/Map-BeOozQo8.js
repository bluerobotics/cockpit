import{bC as Ve,bD as Ne,bE as ze,bF as q,f as $e,bG as xe,bH as Pe,bI as _e,c as Fe,a_ as Be,J as Ue,K as Re,a8 as Xe,u as We,ak as Ye,r as m,k as E,M as we,Y as ke,L as Ge,bJ as u,j as Ze,w as b,o as qe,bK as y,ae as Ke,bL as je,aF as Je,bM as Qe,bN as Te,aC as ea,y as aa,l as S,m as ie,n as F,H as V,N as O,I as B,a6 as K,a1 as j,q as r,as as H,s as A,a2 as J,v as ta,O as Q,V as oa,P as na,Q as la,R as sa,a5 as ia,W as ra,bO as ua,F as ca,z as da,B as va,E as ma,bP as re,_ as fa}from"./index-4flEJmUX.js";function Ie(f,M){if(f==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var l in M)Object.prototype.hasOwnProperty.call(M,l)&&(f[l]=M[l]);return f}function pa(f){return Ie({},f)}var Ce=1440,ga=2520,ue=43200,ha=86400;function ba(f,M,l){var $,P;Ve(2,arguments);var s=_e(),n=($=(P=l==null?void 0:l.locale)!==null&&P!==void 0?P:s.locale)!==null&&$!==void 0?$:Ne;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var t=ze(f,M);if(isNaN(t))throw new RangeError("Invalid time value");var i=Ie(pa(l),{addSuffix:!!(l!=null&&l.addSuffix),comparison:t}),p,d;t>0?(p=q(M),d=q(f)):(p=q(f),d=q(M));var k=$e(d,p),T=(xe(d)-xe(p))/1e3,c=Math.round((k-T)/60),C;if(c<2)return l!=null&&l.includeSeconds?k<5?n.formatDistance("lessThanXSeconds",5,i):k<10?n.formatDistance("lessThanXSeconds",10,i):k<20?n.formatDistance("lessThanXSeconds",20,i):k<40?n.formatDistance("halfAMinute",0,i):k<60?n.formatDistance("lessThanXMinutes",1,i):n.formatDistance("xMinutes",1,i):c===0?n.formatDistance("lessThanXMinutes",1,i):n.formatDistance("xMinutes",c,i);if(c<45)return n.formatDistance("xMinutes",c,i);if(c<90)return n.formatDistance("aboutXHours",1,i);if(c<Ce){var U=Math.round(c/60);return n.formatDistance("aboutXHours",U,i)}else{if(c<ga)return n.formatDistance("xDays",1,i);if(c<ue){var R=Math.round(c/Ce);return n.formatDistance("xDays",R,i)}else if(c<ha)return C=Math.round(c/ue),n.formatDistance("aboutXMonths",C,i)}if(C=Pe(d,p),C<12){var ee=Math.round(c/ue);return n.formatDistance("xMonths",ee,i)}else{var X=C%12,N=Math.floor(C/12);return X<3?n.formatDistance("aboutXYears",N,i):X<9?n.formatDistance("overXYears",N,i):n.formatDistance("almostXYears",N+1,i)}}function ya(f,M){return Ve(1,arguments),ba(f,Date.now(),M)}const Ma=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,xa=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,wa=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,ka=["id"],Ta=Fe({__name:"Map",props:{widget:{}},setup(f){var Me;Be(e=>({61852882:De.value}));const M=f,l=Ue(M).widget,$=Re(),{showDialog:P}=Xe(),s=We(),n=Ye(),t=m(),i=m(n.defaultMapZoom),p=m(n.defaultMapCenter),d=m(),k=E(()=>`map-${l.value.hash}`),T=m(!1);we.registerUsage(ke.latitude),we.registerUsage(ke.longitude),Ge(()=>{Object.keys(l.value.options).length===0&&(l.value.options={showVehiclePath:!0}),g.enableAutoUpdate()});const c=u.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),C=u.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri World Imagery"}),U=u.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),R=u.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),ee={OpenStreetMap:c,"Esri World Imagery":C},X={Seamarks:U,"Marine Profile":R},N=m(),ce=Ze(N),de=u.control.zoom({position:"bottomright"}),ve=u.control.layers(ee,X);b(T,()=>{t.value!==void 0&&(T.value?(t.value.addControl(de),t.value.addControl(ve)):(t.value.removeControl(de),t.value.removeControl(ve)))}),b(ce,()=>{T.value=ce.value}),qe(async()=>{t.value=u.map(k.value,{layers:[c,C,U,R],attributionControl:!1}).setView(p.value,i.value),t.value.removeControl(t.value.zoomControl),t.value.on("moveend",()=>{if(t.value===void 0)return;let{lat:e,lng:a}=t.value.getCenter();e&&a&&(p.value=[e,a])}),t.value.on("zoomend",()=>{var e;t.value!==void 0&&(i.value=((e=t.value)==null?void 0:e.getZoom())??p.value)}),t.value.on("click",()=>{t.value!==void 0&&t.value.on("click",pe)}),t.value.on("contextmenu",()=>{he()}),g.enableAutoUpdate(),window.addEventListener("keydown",be),h.value?g.goToTarget(y.VEHICLE):g.goToTarget(y.HOME)}),Ke(()=>{g.disableAutoUpdate(),window.removeEventListener("keydown",be),t.value&&(t.value.off("click",pe),t.value.off("contextmenu"))}),b(p,(e,a)=>{var o,v,w;e.toString()!==a.toString()&&((o=t.value)==null||o.panTo(e),(w=(v=D.value)==null?void 0:v.getTooltip())==null||w.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),b(t,(e,a)=>{t.value!==void 0&&(e==null?void 0:e.options)===void 0&&(t.value=a)}),b(i,(e,a)=>{var o;e!==a&&((o=t.value)==null||o.setZoom(i.value))}),b(M.widget,()=>{var e;(e=t.value)==null||e.invalidateSize()});const W=m(void 0),g=new je(e=>W.value=e,e=>p.value=e);g.setTrackableTarget(y.VEHICLE,()=>h.value),g.setTrackableTarget(y.HOME,()=>d.value);const h=E(()=>s.coordinates.latitude?[s.coordinates.latitude,s.coordinates.longitude]:void 0),ae=E(()=>{var e;return s.attitude.yaw?Je((e=s.attitude)==null?void 0:e.yaw):0}),me=E(()=>{const e=s.lastHeartbeat;return e?`${ya(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Ee}=Qe(h);(Me=navigator==null?void 0:navigator.geolocation)==null||Me.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let fe=!0;b([d,t],async()=>{d.value===p.value||!t.value||!fe||(g.goToTarget(y.HOME),fe=!1)});const I=m();b(s.coordinates,()=>{if(!(!t.value||!h.value)){if(I.value===void 0){let e=wa;s.vehicleType===Te.MAV_TYPE_SURFACE_BOAT?e=Ma:s.vehicleType===Te.MAV_TYPE_SUBMARINE&&(e=xa);const a=u.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});I.value=u.marker(h.value,{icon:a});const o=u.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});I.value.bindTooltip(o),t.value.addLayer(I.value)}I.value.setLatLng(h.value)}}),b(h,(e,a)=>{W.value===y.VEHICLE||a!==void 0||g.follow(y.VEHICLE)}),b([h,ae,me,()=>s.isArmed],()=>{var a,o,v,w,x;if(I.value===void 0)return;(w=I.value.getTooltip())==null||w.setContent(`
    <p>Coordinates: ${(a=h.value)==null?void 0:a[0].toFixed(6)}, ${(o=h.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((v=s.velocity.ground)==null?void 0:v.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${ae.value.toFixed(2)}°</p>
    <p>${s.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${me.value}</p>
  `);const e=(x=I.value.getElement())==null?void 0:x.querySelector("img");e&&(e.style.transform=`rotate(${ae.value}deg)`)});const D=m();b(d,()=>{if(t.value===void 0)return;const e=d.value;if(e!==void 0){if(D.value===void 0){D.value=u.marker(e);const a=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});D.value.setIcon(a);const o=u.tooltip({content:"No data available",className:"waypoint-tooltip"});D.value.bindTooltip(o),t.value.addLayer(D.value)}D.value.setLatLng(d.value)}});const te=m();b(n.currentPlanningWaypoints,e=>{if(t.value!==void 0){if(te.value===void 0){const a=e.map(o=>o.coordinates);te.value=u.polyline(a,{color:"#358AC3"}).addTo(t.value)}te.value.setLatLngs(e.map(a=>a.coordinates)),e.forEach((a,o)=>{var x;const v=u.marker(a.coordinates),w=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${o}`});v.setIcon(w),(x=t.value)==null||x.addLayer(v)})}});const oe=m();b(Ee,e=>{if(t.value===void 0||e===void 0)return;oe.value===void 0&&(oe.value=u.polyline([],{color:"#ffff00"}).addTo(t.value));const a=e.filter(o=>o.snapshot!==void 0).map(o=>o.snapshot);oe.value.setLatLngs(a)});const Y=m(!1),z=m(null),G=ea({top:"0px",left:"0px"}),L=m(),pe=e=>{var a,o,v,w;if(L.value!==void 0&&t.value!==void 0&&((a=L.value)==null||a.removeFrom(t.value)),((o=e==null?void 0:e.latlng)==null?void 0:o.lat)!=null&&((v=e==null?void 0:e.latlng)==null?void 0:v.lng)!=null){z.value=[e.latlng.lat,e.latlng.lng],Y.value=!0;const x=(w=t.value)==null?void 0:w.getContainer();if(x){const{x:le,y:se}=x.getBoundingClientRect();G.left=`${e.originalEvent.clientX-le}px`,G.top=`${e.originalEvent.clientY-se}px`}}else console.error("Invalid event structure:",e);if(t.value!==void 0){L.value=u.marker(z.value);const x=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});L.value.setIcon(x),t.value.addLayer(L.value)}},ge=e=>{switch(e){case"goto":if(z.value){const x=s.coordinates.altitude??0,le=z.value[0],se=z.value[1];da(async()=>{try{await s.goTo(0,0,0,0,le,se,x)}catch(Ae){re({message:Ae,variant:"error"})}},{command:"GoTo"},va(ma.GOTO))}break;case"set-default-map-position":n.setDefaultMapPosition(p.value,i.value);break;default:console.warn("Unknown menu option selected:",e)}Y.value=!1},he=()=>{Y.value=!1,z.value=null,t.value!==void 0&&L.value!==void 0&&t.value.removeLayer(L.value)},be=e=>{e.key==="Escape"&&he()},Z=m(!1),ne=m(0),Se=async()=>{for(Z.value=!0,ne.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async a=>{ne.value=a};try{(await s.fetchMission(e)).forEach(o=>{n.currentPlanningWaypoints.push(o)}),re({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(a){P({variant:"error",title:"Mission download failed",message:a,timer:5e3})}finally{Z.value=!1}},Oe=async()=>{try{await s.startMission()}catch{re({message:"Failed to start mission.",variant:"error"})}},_=aa(),De=E(()=>`${Math.max(-_.widgetClearanceForVisibleArea(l.value).bottom,0)}px`),ye=E(()=>`${Math.max(-_.widgetClearanceForVisibleArea(l.value).top,0)}px`),Le=E(()=>s.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Vehicle offline (cannot download mission)."),He=E(()=>s.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Vehicle offline (cannot execute mission).");return(e,a)=>(S(),ie(ca,null,[F("div",{ref_key:"mapBase",ref:N,class:ta(["page-base",r(_).editingMode?"pointer-events-none":"pointer-events-auto"])},[F("div",{id:k.value,ref_key:"map",ref:t,class:"map"},[V(J,{location:"top",text:d.value?"Center map on home position.":"Cannot center map on home (home position undefined)."},{activator:O(({props:o})=>[T.value?(S(),B(K,j({key:0},o,{class:["absolute left-0 m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"],color:W.value==r(y).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:a[0]||(a[0]=H(v=>r(g).goToTarget(r(y).HOME,!0),["stop"])),onDblclick:a[1]||(a[1]=H(v=>r(g).follow(r(y).HOME),["stop"]))}),null,16,["class","color","disabled"])):A("",!0)]),_:1},8,["text"]),V(J,{location:"top",text:h.value?"Center map on vehicle position.":"Cannot center map on vehicle (vehicle offline)."},{activator:O(({props:o})=>[T.value?(S(),B(K,j({key:0},o,{class:["absolute m-3 bottom-button left-10 bg-slate-50",h.value?"":"active-events-on-disabled"],color:W.value==r(y).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!h.value,onClick:a[2]||(a[2]=H(v=>r(g).goToTarget(r(y).VEHICLE,!0),["stop"])),onDblclick:a[3]||(a[3]=H(v=>r(g).follow(r(y).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):A("",!0)]),_:1},8,["text"]),V(J,{location:"top",text:Le.value},{activator:O(({props:o})=>[T.value?(S(),B(K,j({key:0},o,{class:["absolute m-3 bottom-button left-20 bg-slate-50",r(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:H(Se,["stop"])}),null,16,["class","disabled"])):A("",!0)]),_:1},8,["text"]),V(J,{location:"top",text:He.value},{activator:O(({props:o})=>[T.value?(S(),B(K,j({key:0},o,{class:["absolute mb-3 ml-1 bottom-button left-32 bg-slate-50",r(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:H(Oe,["stop"])}),null,16,["class","disabled"])):A("",!0)]),_:1},8,["text"])],8,ka)],2),Y.value?(S(),ie("div",{key:0,class:"context-menu",style:Q({top:G.top,left:G.left})},[F("ul",{onClick:a[6]||(a[6]=H(()=>{},["stop"]))},[F("li",{onClick:a[4]||(a[4]=o=>ge("goto"))},"GoTo"),F("li",{onClick:a[5]||(a[5]=o=>ge("set-default-map-position"))},"Set default map position")])],4)):A("",!0),V(ra,{modelValue:r(_).widgetManagerVars(r(l).hash).configMenuOpen,"onUpdate:modelValue":a[8]||(a[8]=o=>r(_).widgetManagerVars(r(l).hash).configMenuOpen=o),width:"auto"},{default:O(()=>[V(oa,{class:"pa-2",style:Q(r($).globalGlassMenuStyles)},{default:O(()=>[V(na,{class:"text-center"},{default:O(()=>a[9]||(a[9]=[la("Map widget settings")])),_:1}),V(sa,null,{default:O(()=>[V(ia,{modelValue:r(l).options.showVehiclePath,"onUpdate:modelValue":a[7]||(a[7]=o=>r(l).options.showVehiclePath=o),class:"my-1",label:"Show vehicle path",color:r(l).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),Z.value?(S(),B(ua,{key:1,"model-value":ne.value,height:"10",absolute:"",bottom:"",color:"white",style:Q(`top: ${ye.value}`)},null,8,["model-value","style"])):A("",!0),Z.value?(S(),ie("p",{key:2,style:Q({top:ye.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):A("",!0)],64))}}),Va=fa(Ta,[["__scopeId","data-v-9581b62a"]]);export{Va as default};
