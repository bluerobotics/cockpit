import{c as Je,bO as Qe,k as w,J as Xe,K as et,aG as tt,u as ot,aR as at,r as l,M as Pe,Y as Se,L as nt,bY as it,bZ as i,j as st,w as d,o as lt,b_ as m,aM as rt,bi as ct,b$ as ut,c0 as dt,c1 as $e,c2 as vt,c3 as mt,c4 as pt,av as gt,aZ as I,y as ft,bm as ht,bF as yt,l as ae,m as C,G as bt,H as b,I as D,s as A,x as xt,v as c,n as kt,N as E,ai as G,aj as j,b5 as _,ay as Y,c5 as wt,V as Mt,O as ne,P as Tt,Q as Ct,R as Et,aE as Vt,W as Lt,c6 as It,c7 as Ot,F as Pt,_ as St}from"./index-Bts4qd0i.js";const $t=["id"],Ht=Je({__name:"Map",props:{widget:{}},setup(He){var Oe;Qe(e=>({"02816928":Ze.value}));const ie=He,x=Xe(ie).widget,Ae=et(),{showDialog:_e}=tt(),s=ot(),f=at(),o=l(),z=l(f.defaultMapZoom),O=l(f.defaultMapCenter),h=l(),se=w(()=>`map-${x.value.hash}`),V=l(!1),le=l(!1),q=l([]),re=l(),K=l(!1),J=l(!1);let ce;const ue=e=>{e.touches.length>1&&(J.value=!0,M.value&&W(),clearTimeout(ce))},de=e=>{e.touches.length<=1&&(ce=window.setTimeout(()=>J.value=!1,300))},P=l(null),y=l({});Pe.registerUsage(Se.latitude),Pe.registerUsage(Se.longitude),nt(()=>{Object.keys(x.value.options).length===0&&(x.value.options={showVehiclePath:!0}),p.enableAutoUpdate()});const ve=i.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),me=i.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),pe=i.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),ge=i.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),ze={OpenStreetMap:ve,"Esri World Imagery":me},Fe={Seamarks:pe,"Marine Profile":ge},S=l(),fe=st(S),he=i.control.zoom({position:"bottomright"}),ye=i.control.layers(ze,Fe);d(V,()=>{o.value!==void 0&&(V.value?(o.value.addControl(he),o.value.addControl(ye)):(o.value.removeControl(he),o.value.removeControl(ye)))}),d(fe,()=>{V.value=fe.value}),lt(async()=>{var e,t;(e=S.value)==null||e.addEventListener("touchstart",ue,{passive:!0}),(t=S.value)==null||t.addEventListener("touchend",de,{passive:!0}),o.value=i.map(se.value,{layers:[ve,me,pe,ge],attributionControl:!1}).setView(O.value,z.value),o.value.removeControl(o.value.zoomControl),o.value.on("click",a=>{v.value=[a.latlng.lat,a.latlng.lng]}),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:a,lng:n}=o.value.getCenter();a&&n&&(O.value=[a,n])}),o.value.on("dragstart",()=>{K.value=!0}),o.value.on("dragend",()=>{setTimeout(()=>K.value=!1,200)}),o.value.on("zoomend",()=>{var a;M.value=!1,o.value!==void 0&&(z.value=((a=o.value)==null?void 0:a.getZoom())??O.value)}),o.value.on("contextmenu",a=>{v.value=[a.latlng.lat,a.latlng.lng]}),p.enableAutoUpdate(),window.addEventListener("keydown",Me),g.value?p.goToTarget(m.VEHICLE):p.goToTarget(m.HOME),!s.isVehicleOnline&&f.vehicleMission.length&&te(f.vehicleMission),le.value=!0,await Q()});const Ne={open:e=>{if(!o.value||J.value||K.value)return;e.preventDefault(),e.stopPropagation();const t=o.value.mouseEventToContainerPoint(e),a=o.value.containerPointToLatLng(t);v.value=[a.lat,a.lng],re.value.openAt(e),M.value=!0},close:()=>{W()}},be=()=>{var e;(e=o.value)==null||e.eachLayer(t=>{(t instanceof i.Marker||t instanceof i.Polyline&&t.options.color==="#358AC3")&&o.value.removeLayer(t)}),q.value=[],B.value=void 0,L.value=void 0,H.value=void 0},Q=async()=>{le.value&&(be(),s.isVehicleOnline?await Ce():f.vehicleMission.length&&te(f.vehicleMission))};d(()=>s.isVehicleOnline,()=>{Q()}),d(()=>f.vehicleMissionRevision,()=>{Q()}),rt(()=>{var e,t;p.disableAutoUpdate(),window.removeEventListener("keydown",Me),o.value&&(o.value.off("contextmenu"),Object.values(y.value).forEach(a=>a.remove()),y.value={}),(e=S.value)==null||e.removeEventListener("touchstart",ue),(t=S.value)==null||t.removeEventListener("touchend",de)}),d(O,(e,t)=>{var a;e.toString()!==t.toString()&&((a=o.value)==null||a.panTo(e))}),d(o,(e,t)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=t)}),d(z,(e,t)=>{var a;e!==t&&(M.value=!1,(a=o.value)==null||a.setZoom(z.value))}),d(ie.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const $=l(void 0),p=new it(e=>$.value=e,e=>O.value=e);p.setTrackableTarget(m.VEHICLE,()=>g.value),p.setTrackableTarget(m.HOME,()=>h.value);const g=w(()=>s.coordinates.latitude?[s.coordinates.latitude,s.coordinates.longitude]:void 0),X=w(()=>{var e;return s.attitude.yaw?ct((e=s.attitude)==null?void 0:e.yaw):0}),xe=w(()=>{const e=s.lastHeartbeat;return e?`${ut(e??0,{includeSeconds:!0})} ago`:"never"}),{history:De}=dt(g);(Oe=navigator==null?void 0:navigator.geolocation)==null||Oe.watchPosition(e=>{h.value||(h.value=[e.coords.latitude,e.coords.longitude])},e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let ke=!0;d([h,o],async()=>{h.value===O.value||!o.value||!ke||(p.goToTarget(m.HOME),ke=!1)});const T=l();d(s.coordinates,()=>{if(!(!o.value||!g.value)){if(T.value===void 0){let e=vt;s.vehicleType===$e.MAV_TYPE_SURFACE_BOAT?e=mt:s.vehicleType===$e.MAV_TYPE_SUBMARINE&&(e=pt);const t=i.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});T.value=i.marker(g.value,{icon:t});const a=i.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});T.value.bindTooltip(a),o.value.addLayer(T.value)}T.value.setLatLng(g.value)}}),d(g,(e,t)=>{$.value===m.VEHICLE||t!==void 0||p.follow(m.VEHICLE)}),d([g,X,xe,()=>s.isArmed],()=>{var t,a,n,u,r;if(T.value===void 0)return;(u=T.value.getTooltip())==null||u.setContent(`
    <p>Coordinates: ${(t=g.value)==null?void 0:t[0].toFixed(6)}, ${(a=g.value)==null?void 0:a[1].toFixed(6)}</p>
    <p>Velocity: ${((n=s.velocity.ground)==null?void 0:n.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${X.value.toFixed(2)}°</p>
    <p>${s.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${xe.value}</p>
  `);const e=(r=T.value.getElement())==null?void 0:r.querySelector("img");e&&(e.style.transform=`rotate(${X.value}deg)`)});const L=l();d(h,()=>{if(o.value===void 0)return;const e=h.value;if(e!==void 0)if(L.value)L.value.setLatLng(e);else{L.value=i.marker(e,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=i.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});L.value.bindTooltip(t),L.value.on("dragend",a=>{const u=a.target.getLatLng();oe([u.lat,u.lng])}),o.value.addLayer(L.value)}});const B=l();d(q,e=>{o.value&&(B.value||(B.value=i.polyline([],{color:"#358AC3"}).addTo(o.value)),B.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,a)=>{var r;const n=i.marker(t.coordinates);n.setIcon(i.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]}));const u=i.tooltip({content:a.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});n.bindTooltip(u),(r=o.value)==null||r.addLayer(n)}))},{deep:!0});const ee=l();d(De,e=>{if(o.value===void 0||e===void 0)return;ee.value===void 0&&(ee.value=i.polyline([],{color:"#ffff00"}).addTo(o.value));const t=e.filter(a=>a.snapshot!==void 0).map(a=>a.snapshot);ee.value.setLatLngs(t)});const M=l(!1),v=l(null),we=l(),Be=gt([{item:"Set home waypoint",action:()=>R("set-home-waypoint"),icon:"mdi-home-map-marker"},{item:"Place Point of Interest",action:()=>R("place-poi"),icon:"mdi-map-marker-plus"},{item:"GoTo",action:()=>R("goto"),icon:"mdi-crosshairs-gps"},{item:"Set default map position",action:()=>R("set-default-map-position"),icon:"mdi-map-check"}]),H=l(),Re=async()=>{var e;if(!(!o.value||!v.value))try{await f.setDefaultMapPosition(v.value,z.value),I({message:"Default map position set",variant:"success"});const t=i.marker(v.value,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value),a=i.tooltip({content:'<i class="mdi mdi-map-check text-[18px] border-[1px] rounded-full px-[2px] py-[1px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});t.bindTooltip(a).openTooltip();const n=t.getElement(),u=(e=t.getTooltip())==null?void 0:e.getElement();[n,u].forEach(r=>{r&&(r.style.transition="opacity 1s",r.style.opacity="1")}),setTimeout(()=>{[n,u].forEach(r=>{r&&(r.style.opacity="0")}),setTimeout(()=>{var r;(r=o.value)==null||r.removeLayer(t)},1e3)},1500)}catch(t){console.error(t),I({message:"Failed to set default map position",variant:"error"})}},We=async()=>{if(!v.value||!o.value)return;H.value&&(o.value.removeLayer(H.value),H.value=void 0),H.value=i.marker(v.value,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value);const e=i.tooltip({content:'<i class="mdi mdi-crosshairs-gps border-[1px] rounded-full text-[18px] px-[2px] pt-[1px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});if(H.value.bindTooltip(e),v.value){const r=s.coordinates.altitude??0,k=v.value[0],N=v.value[1];try{await s.goTo(0,0,0,0,k,N,r)}catch(Z){I({message:`GoTo request failed: ${Z.message}`,variant:"error"})}}},R=async e=>{switch(e){case"goto":{We();break}case"set-default-map-position":Re();break;case"place-poi":v.value&&P.value?P.value.openDialog(v.value):v.value?P.value||(I({message:"POI Manager (map widget) is not available.",variant:"error"}),console.error("Cannot open POI dialog, POI Manager (map widget) ref is not set.")):(I({message:"Cannot place Point of Interest without map coordinates.",variant:"error"}),console.error("Cannot open POI dialog without click coordinates for new POI"));break;case"set-home-waypoint":v.value&&oe(v.value);break;default:console.warn("Unknown menu option selected:",e)}M.value=!1},W=()=>{M.value=!1,o.value!==void 0&&we.value!==void 0&&o.value.removeLayer(we.value)},Me=e=>{e.key==="Escape"&&W()},te=e=>{e.forEach((t,a)=>{a===0?(h.value=t.coordinates,oe(t.coordinates)):q.value.push(t)})},U=l(!1),Te=l(0),Ce=async()=>{U.value=!0,be();const e=async t=>{Te.value=t};try{const t=await s.fetchMission(e);te(t),I({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){_e({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{U.value=!1}},oe=async e=>{const t=[e[0],e[1]];h.value=t,await s.setHomeWaypoint(t,0),M.value&&(M.value=!1)},Ue=async()=>{try{await s.startMission()}catch{I({message:"Failed to start mission.",variant:"error"})}},F=ft(),Ze=w(()=>`${Math.max(-F.widgetClearanceForVisibleArea(x.value).bottom,0)}px`),Ee=w(()=>`${Math.max(-F.widgetClearanceForVisibleArea(x.value).top,0)}px`),Ge=w(()=>s.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),je=w(()=>s.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),Ye=w(()=>h.value===void 0?"Cannot center map on home (home position undefined).":$.value===m.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),qe=w(()=>s.isVehicleOnline?g.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":$.value===m.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline)."),Ve=e=>({html:`
    <div class="poi-marker-container">
      <div class="poi-marker-background" style="background-color: ${e.color}80;"></div>
      <i class="v-icon notranslate mdi ${e.icon}" style="color: rgba(255, 255, 255, 0.7); position: relative; z-index: 2;"></i>
    </div>
  `,className:"poi-marker-icon-widget",iconSize:[32,32],iconAnchor:[16,32]}),Le=e=>{if(!o.value||!o.value.getContainer())return;const t=i.divIcon(Ve(e)),a=i.marker(e.coordinates,{icon:t,draggable:!0}).addTo(o.value),n=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `,u={permanent:!1,direction:"top",offset:[0,-40],className:"poi-tooltip-widget"};a.bindTooltip(n,u),a.on("drag",r=>{var Z;const k=r.target.getLatLng(),N=`
      <strong>${e.name}</strong><br>
      ${e.description?e.description+"<br>":""}
      Lat: ${k.lat.toFixed(8)}, Lng: ${k.lng.toFixed(8)}
    `;(Z=a.getTooltip())==null||Z.setContent(N)}),a.on("dragend",r=>{const k=r.target.getLatLng();f.movePointOfInterest(e.id,[k.lat,k.lng])}),a.on("click",r=>{if(i.DomEvent.stopPropagation(r),P.value){const k=f.pointsOfInterest.find(N=>N.id===e.id);k?P.value.openDialog(void 0,k):console.warn("POI not found in store:",e.id)}}),y.value[e.id]=a},Ie=e=>{var n;if(!o.value||!o.value.getContainer()||!y.value[e.id])return;const t=y.value[e.id];t.setLatLng(e.coordinates),t.setIcon(i.divIcon(Ve(e)));const a=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `;(n=t.getTooltip())==null||n.setContent(a)},Ke=e=>{!o.value||!y.value[e]||(y.value[e].remove(),delete y.value[e])};return d(()=>f.pointsOfInterest,async e=>{if((!o.value||!o.value.getContainer())&&(await ht(),!o.value||!o.value.getContainer())){console.warn("Map.vue: POI watcher - map not ready after nextTick.");return}const t=new Set(e.map(a=>a.id));Object.keys(y.value).forEach(a=>{t.has(a)||Ke(a)}),e.forEach(a=>{y.value[a.id]?Ie(a):Le(a)})},{deep:!0,immediate:!0}),d(o,e=>{e&&e.getContainer()&&f.pointsOfInterest.forEach(t=>{y.value[t.id]?Ie(t):Le(t)})},{immediate:!0}),(e,t)=>{const a=yt("contextmenu");return C(),ae(Pt,null,[bt((C(),ae("div",{ref_key:"mapBase",ref:S,class:xt(["page-base",c(F).editingMode?"pointer-events-none":"pointer-events-auto"])},[kt("div",{id:se.value,ref_key:"map",ref:o,class:"map"},[b(Y,{location:"top",text:Ye.value},{activator:E(({props:n})=>[V.value?(C(),D(G,j({key:0},n,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50 text-[14px]",h.value?"":"active-events-on-disabled"],color:$.value==c(m).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-search",size:"x-small",disabled:!h.value,onClick:t[0]||(t[0]=_(u=>c(p).goToTarget(c(m).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=_(u=>c(p).follow(c(m).HOME),["stop"]))}),null,16,["class","color","disabled"])):A("",!0)]),_:1},8,["text"]),b(Y,{location:"top",text:qe.value},{activator:E(({props:n})=>[V.value?(C(),D(G,j({key:0},n,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50 text-[14px]",g.value?"":"active-events-on-disabled"],color:$.value==c(m).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!g.value,onClick:t[2]||(t[2]=_(u=>c(p).goToTarget(c(m).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=_(u=>c(p).follow(c(m).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):A("",!0)]),_:1},8,["text"]),b(Y,{location:"top",text:Ge.value},{activator:E(({props:n})=>[V.value?(C(),D(G,j({key:0},n,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50 text-[14px]",c(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!c(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:_(Ce,["stop"])}),null,16,["class","disabled"])):A("",!0)]),_:1},8,["text"]),b(Y,{location:"top",text:je.value},{activator:E(({props:n})=>[V.value?(C(),D(G,j({key:0},n,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50 text-[14px]",c(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!c(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:_(Ue,["stop"])}),null,16,["class","disabled"])):A("",!0)]),_:1},8,["text"])],8,$t)],2)),[[a,Ne]]),b(wt,{ref_key:"contextMenuRef",ref:re,visible:M.value,width:"260px","menu-items":Be,onClose:W},null,8,["visible","menu-items"]),b(Lt,{modelValue:c(F).widgetManagerVars(c(x).hash).configMenuOpen,"onUpdate:modelValue":t[5]||(t[5]=n=>c(F).widgetManagerVars(c(x).hash).configMenuOpen=n),width:"auto"},{default:E(()=>[b(Mt,{class:"pa-2",style:ne(c(Ae).globalGlassMenuStyles)},{default:E(()=>[b(Tt,{class:"text-center"},{default:E(()=>t[6]||(t[6]=[Ct("Map widget settings")])),_:1,__:[6]}),b(Et,null,{default:E(()=>[b(Vt,{modelValue:c(x).options.showVehiclePath,"onUpdate:modelValue":t[4]||(t[4]=n=>c(x).options.showVehiclePath=n),class:"my-1",label:"Show vehicle path",color:c(x).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),U.value?(C(),D(It,{key:0,"model-value":Te.value,height:"10",absolute:"",bottom:"",color:"white",style:ne(`top: ${Ee.value}`)},null,8,["model-value","style"])):A("",!0),U.value?(C(),ae("p",{key:1,style:ne({top:Ee.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):A("",!0),b(Ot,{ref_key:"poiManagerMapWidgetRef",ref:P},null,512)],64)}}}),_t=St(Ht,[["__scopeId","data-v-3482a984"]]);export{_t as default};
