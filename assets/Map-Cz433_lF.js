import{bf as Te,bg as De,bh as He,bi as Y,f as Le,bj as me,bk as Ae,bl as Oe,c as Ne,b9 as ze,I as $e,K as Fe,a7 as Pe,u as Be,aj as _e,r as v,k as $,M as fe,Y as pe,L as Ue,bm as c,j as Re,w as g,o as Xe,bn as h,ad as We,bo as Ye,aw as qe,bp as Ge,bq as ge,at as je,J as Ze,l as S,m as he,n as q,q as be,T as ye,H as F,x as le,s as i,aq as D,a5 as G,v as A,O as Me,G as P,N as j,V as Ke,P as Je,Q as Qe,R as ea,a4 as aa,W as oa,br as ta,F as la,z as na,B as sa,E as ia,bs as ne}from"./index-BBnA6cql.js";function we(m,b){if(m==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var l in b)Object.prototype.hasOwnProperty.call(b,l)&&(m[l]=b[l]);return m}function ra(m){return we({},m)}var ke=1440,ua=2520,se=43200,ca=86400;function da(m,b,l){var O,N;Te(2,arguments);var r=Oe(),n=(O=(N=l==null?void 0:l.locale)!==null&&N!==void 0?N:r.locale)!==null&&O!==void 0?O:De;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var o=He(m,b);if(isNaN(o))throw new RangeError("Invalid time value");var s=we(ra(l),{addSuffix:!!(l!=null&&l.addSuffix),comparison:o}),y,d;o>0?(y=Y(b),d=Y(m)):(y=Y(m),d=Y(b));var w=Le(d,y),x=(me(d)-me(y))/1e3,u=Math.round((w-x)/60),C;if(u<2)return l!=null&&l.includeSeconds?w<5?n.formatDistance("lessThanXSeconds",5,s):w<10?n.formatDistance("lessThanXSeconds",10,s):w<20?n.formatDistance("lessThanXSeconds",20,s):w<40?n.formatDistance("halfAMinute",0,s):w<60?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",1,s):u===0?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",u,s);if(u<45)return n.formatDistance("xMinutes",u,s);if(u<90)return n.formatDistance("aboutXHours",1,s);if(u<ke){var Z=Math.round(u/60);return n.formatDistance("aboutXHours",Z,s)}else{if(u<ua)return n.formatDistance("xDays",1,s);if(u<se){var B=Math.round(u/ke);return n.formatDistance("xDays",B,s)}else if(u<ca)return C=Math.round(u/se),n.formatDistance("aboutXMonths",C,s)}if(C=Ae(d,y),C<12){var _=Math.round(u/se);return n.formatDistance("xMonths",_,s)}else{var z=C%12,H=Math.floor(C/12);return z<3?n.formatDistance("aboutXYears",H,s):z<9?n.formatDistance("overXYears",H,s):n.formatDistance("almostXYears",H+1,s)}}function va(m,b){return Te(1,arguments),da(m,Date.now(),b)}const ma="/assets/blueboat-marker-DyHmCFOq.png",fa="/assets/brov2-marker-CBzp11FX.png",pa="/assets/generic-vehicle-marker-SovxT5Tc.png",ga=["id"],ba=Ne({__name:"Map",props:{widget:{}},setup(m){var ve;ze(e=>({27518064:Ve.value}));const b=m,l=$e(b).widget,O=Fe(),{showDialog:N}=Pe(),r=Be(),n=_e(),o=v(),s=v(15),y=v([-27.5935,-48.55854]),d=v(),w=$(()=>`map-${l.value.hash}`),x=v(!1);fe.registerUsage(pe.latitude),fe.registerUsage(pe.longitude),Ue(()=>{Object.keys(l.value.options).length===0&&(l.value.options={showVehiclePath:!0}),f.enableAutoUpdate()});const u=c.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),C=c.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri World Imagery"}),Z={OpenStreetMap:u,"Esri World Imagery":C},B=v(),_=Re(B),z=c.control.zoom({position:"bottomright"}),H=c.control.layers(Z);g(x,()=>{o.value!==void 0&&(x.value?(o.value.addControl(z),o.value.addControl(H)):(o.value.removeControl(z),o.value.removeControl(H)))}),g(_,()=>{x.value=_.value}),Xe(async()=>{o.value=c.map(w.value,{layers:[u,C],attributionControl:!1}).setView(y.value,s.value),o.value.removeControl(o.value.zoomControl),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:e,lng:a}=o.value.getCenter();e&&a&&(y.value=[e,a])}),o.value.on("zoomend",()=>{var e;o.value!==void 0&&(s.value=((e=o.value)==null?void 0:e.getZoom())??y.value)}),o.value.on("click",()=>{o.value!==void 0&&o.value.on("click",ue)}),o.value.on("contextmenu",()=>{ce()}),f.enableAutoUpdate(),window.addEventListener("keydown",de),p.value?f.goToTarget(h.VEHICLE):f.goToTarget(h.HOME)}),We(()=>{f.disableAutoUpdate(),window.removeEventListener("keydown",de),o.value&&(o.value.off("click",ue),o.value.off("contextmenu"))}),g(y,(e,a)=>{var t,M,T;e.toString()!==a.toString()&&((t=o.value)==null||t.panTo(e),(T=(M=E.value)==null?void 0:M.getTooltip())==null||T.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),g(o,(e,a)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=a)}),g(s,(e,a)=>{var t;e!==a&&((t=o.value)==null||t.setZoom(s.value))}),g(b.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const U=v(void 0),f=new Ye(e=>U.value=e,e=>y.value=e);f.setTrackableTarget(h.VEHICLE,()=>p.value),f.setTrackableTarget(h.HOME,()=>d.value);const p=$(()=>r.coordinates.latitude?[r.coordinates.latitude,r.coordinates.longitude]:void 0),K=$(()=>{var e;return r.attitude.yaw?qe((e=r.attitude)==null?void 0:e.yaw):0}),ie=$(()=>{const e=r.lastHeartbeat;return e?`${va(e??0,{includeSeconds:!0})} ago`:"never"}),{history:xe}=Ge(p);(ve=navigator==null?void 0:navigator.geolocation)==null||ve.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let re=!0;g([d,o],async()=>{d.value===y.value||!o.value||!re||(f.goToTarget(h.HOME),re=!1)});const I=v();g(r.coordinates,()=>{if(!(!o.value||!p.value)){if(I.value===void 0){let e=pa;r.vehicleType===ge.MAV_TYPE_SURFACE_BOAT?e=ma:r.vehicleType===ge.MAV_TYPE_SUBMARINE&&(e=fa);const a=c.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});I.value=c.marker(p.value,{icon:a});const t=c.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});I.value.bindTooltip(t),o.value.addLayer(I.value)}I.value.setLatLng(p.value)}}),g(p,(e,a)=>{U.value===h.VEHICLE||a!==void 0||f.follow(h.VEHICLE)}),g([p,K,ie,()=>r.isArmed],()=>{var a,t,M,T,k;if(I.value===void 0)return;(T=I.value.getTooltip())==null||T.setContent(`
    <p>Coordinates: ${(a=p.value)==null?void 0:a[0].toFixed(6)}, ${(t=p.value)==null?void 0:t[1].toFixed(6)}</p>
    <p>Velocity: ${((M=r.velocity.ground)==null?void 0:M.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${K.value.toFixed(2)}°</p>
    <p>${r.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${ie.value}</p>
  `);const e=(k=I.value.getElement())==null?void 0:k.querySelector("img");e&&(e.style.transform=`rotate(${K.value}deg)`)});const E=v();g(d,()=>{if(o.value===void 0)return;const e=d.value;if(e!==void 0){if(E.value===void 0){E.value=c.marker(e);const a=c.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});E.value.setIcon(a);const t=c.tooltip({content:"No data available",className:"waypoint-tooltip"});E.value.bindTooltip(t),o.value.addLayer(E.value)}E.value.setLatLng(d.value)}});const J=v();g(n.currentPlanningWaypoints,e=>{if(o.value!==void 0){if(J.value===void 0){const a=e.map(t=>t.coordinates);J.value=c.polyline(a,{color:"#358AC3"}).addTo(o.value)}J.value.setLatLngs(e.map(a=>a.coordinates)),e.forEach((a,t)=>{var k;const M=c.marker(a.coordinates),T=c.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${t}`});M.setIcon(T),(k=o.value)==null||k.addLayer(M)})}});const Q=v();g(xe,e=>{if(o.value===void 0||e===void 0)return;Q.value===void 0&&(Q.value=c.polyline([],{color:"#358AC3"}).addTo(o.value));const a=e.filter(t=>t.snapshot!==void 0).map(t=>t.snapshot);Q.value.setLatLngs(a)});const R=v(!1),L=v(null),X=je({top:"0px",left:"0px"}),V=v(),ue=e=>{var a,t,M,T;if(V.value!==void 0&&o.value!==void 0&&((a=V.value)==null||a.removeFrom(o.value)),((t=e==null?void 0:e.latlng)==null?void 0:t.lat)!=null&&((M=e==null?void 0:e.latlng)==null?void 0:M.lng)!=null){L.value=[e.latlng.lat,e.latlng.lng],R.value=!0;const k=(T=o.value)==null?void 0:T.getContainer();if(k){const{x:oe,y:te}=k.getBoundingClientRect();X.left=`${e.originalEvent.clientX-oe}px`,X.top=`${e.originalEvent.clientY-te}px`}}else console.error("Invalid event structure:",e);if(o.value!==void 0){V.value=c.marker(L.value);const k=c.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});V.value.setIcon(k),o.value.addLayer(V.value)}},Ce=e=>{switch(e){case"goto":if(L.value){const k=r.coordinates.altitude??0,oe=L.value[0],te=L.value[1];na(async()=>{try{await r.goTo(0,0,0,0,oe,te,k)}catch(Se){ne({message:Se,variant:"error"})}},{command:"GoTo"},sa(ia.GOTO))}break;default:console.warn("Unknown menu option selected:",e)}R.value=!1},ce=()=>{R.value=!1,L.value=null,o.value!==void 0&&V.value!==void 0&&o.value.removeLayer(V.value)},de=e=>{e.key==="Escape"&&ce()},ee=v(!1),ae=v(0),Ie=async()=>{for(ee.value=!0,ae.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async a=>{ae.value=a};try{(await r.fetchMission(e)).forEach(t=>{n.currentPlanningWaypoints.push(t)}),ne({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(a){N({variant:"error",title:"Mission download failed",message:a,timer:5e3})}finally{ee.value=!1}},Ee=async()=>{try{await r.startMission()}catch{ne({message:"Failed to start mission.",variant:"error"})}},W=Ze(),Ve=$(()=>`${Math.max(-W.widgetClearanceForVisibleArea(l.value).bottom,0)}px`);return(e,a)=>(S(),he(la,null,[q("div",{ref_key:"mapBase",ref:B,class:le(["page-base",i(W).editingMode?"pointer-events-none":"pointer-events-auto"])},[q("div",{id:w.value,ref_key:"map",ref:o,class:"map"},[x.value?be((S(),F(G,{key:0,class:le(["absolute left-0 m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"]),color:U.value==i(h).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:a[0]||(a[0]=D(t=>i(f).goToTarget(i(h).HOME,!0),["stop"])),onDblclick:a[1]||(a[1]=D(t=>i(f).follow(i(h).HOME),["stop"]))},null,8,["class","color","disabled"])),[[ye,d.value?"Center map on home position.":"Home position is currently undefined."]]):A("",!0),x.value?be((S(),F(G,{key:1,class:le(["absolute m-3 bottom-button left-10 bg-slate-50",p.value?"":"active-events-on-disabled"]),color:U.value==i(h).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!p.value,onClick:a[2]||(a[2]=D(t=>i(f).goToTarget(i(h).VEHICLE,!0),["stop"])),onDblclick:a[3]||(a[3]=D(t=>i(f).follow(i(h).VEHICLE),["stop"]))},null,8,["class","color","disabled"])),[[ye,p.value?"Center map on vehicle position.":"Vehicle position is currently undefined."]]):A("",!0),x.value?(S(),F(G,{key:2,class:"absolute m-3 bottom-button left-20 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:D(Ie,["stop"])})):A("",!0),x.value?(S(),F(G,{key:3,class:"absolute mb-3 ml-1 bottom-button left-32 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:D(Ee,["stop"])})):A("",!0)],8,ga)],2),R.value?(S(),he("div",{key:0,class:"context-menu",style:Me({top:X.top,left:X.left})},[q("ul",{onClick:a[5]||(a[5]=D(()=>{},["stop"]))},[q("li",{onClick:a[4]||(a[4]=t=>Ce("goto"))},"GoTo")])],4)):A("",!0),P(oa,{modelValue:i(W).widgetManagerVars(i(l).hash).configMenuOpen,"onUpdate:modelValue":a[7]||(a[7]=t=>i(W).widgetManagerVars(i(l).hash).configMenuOpen=t),width:"auto"},{default:j(()=>[P(Ke,{class:"pa-2",style:Me(i(O).globalGlassMenuStyles)},{default:j(()=>[P(Je,{class:"text-center"},{default:j(()=>a[8]||(a[8]=[Qe("Map widget settings")])),_:1}),P(ea,null,{default:j(()=>[P(aa,{modelValue:i(l).options.showVehiclePath,"onUpdate:modelValue":a[6]||(a[6]=t=>i(l).options.showVehiclePath=t),class:"my-1",label:"Show vehicle path",color:i(l).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),ee.value?(S(),F(ta,{key:1,"model-value":ae.value,height:"10",absolute:"",bottom:"",color:"white"},null,8,["model-value"])):A("",!0)],64))}});export{ba as default};
