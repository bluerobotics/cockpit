import{c as te,a8 as ae,r as N,bw as se,w as L,o as re,h as ie,l as y,m as g,n as i,_ as le,bx as ue,b9 as de,s as n,K as ve,J as me,a9 as ce,I as pe,L as fe,k as I,ac as ye,ad as ge,H as Se,v as be,t as T,F as _,p as X,Q as C,G as c,N as k,V as Ve,O as xe,P as he,R as we,ah as Z,a4 as J,a5 as ee,W as ke}from"./index-qH44zNBu.js";const Ne={class:"canvas-container"},Fe=["width","height"],H=100,Ie=60,Ce=te({__name:"VideoPlayerStatsForNerds",props:{width:{type:Number,default:130},height:{type:Number,default:200},updateInterval:{type:Number,default:20},streamName:{type:String,default:""}},setup(R){const O=ae(),r=R,P=N(null),u=N([]),h=N([]);let a=null,s=null,S=0,v=0,F=0,p=0,z=0,$=0,A=0,U=0,B=!1,E=0,j=0,o=0,e=0,l=0,b=0,W=0,q=1e3,D=30,K=120;function Q(V,t){return V/t*Ie}function Y(){const t=P.value.getContext("2d"),{width:m,height:x}=r;t.clearRect(0,0,m,x),t.strokeStyle="rgb(255, 165, 0)",t.lineWidth=1,t.beginPath();for(let d=0;d<h.value.length;d++){const w=d/(H-1)*m,M=x-Q(h.value[d],q);d===0?t.moveTo(w,M):t.lineTo(w,M)}t.stroke(),t.strokeStyle="rgb(0, 255, 0)",t.beginPath();for(let d=0;d<u.value.length;d++){const w=d/(H-1)*m,M=x-Q(u.value[d],D);d===0?t.moveTo(w,M):t.lineTo(w,M)}t.stroke();const f=B?"red":"white",ne=[{label:"Stream",value:r.streamName,color:f},{label:"Size",value:W?`${W}p`:"N/A",color:f},{label:"Packets Lost",value:`${v} (${l.toFixed(0)}%)`,color:f},{label:"Frame drops",value:e,color:f},{label:"Nack",value:z,color:f},{label:"Pli",value:$,color:f},{label:"Fir",value:A,color:f},{label:"Processing ",value:`${E.toFixed(0)}ms`,color:f},{label:"Freezes",value:`${j}(${o.toFixed(1)}s)`,color:f},{label:"Bitrate",value:`${S.toFixed(0)}kbps`,color:"rgb(255, 165, 0)"},{label:"FPS",value:b.toFixed(2),color:"rgb(0, 255, 0)"}];t.font="10px Arial",ne.forEach((d,w)=>{t.fillStyle=d.color,t.fillText(`${d.label}: ${d.value}`,5,12+w*12)}),a=requestAnimationFrame(Y)}const G=new se({getStatsInterval:100});function oe(){u.value.push(b),h.value.push(S),u.value.length>H&&u.value.shift(),h.value.length>H&&h.value.shift(),q=Math.max(q,...h.value),D=Math.max(D,...u.value),D>K&&(D=K)}return L(O.activeStreams,V=>{Object.keys(V).forEach(t=>{var x;if(t!==r.streamName)return;const m=(x=V[t])==null?void 0:x.webRtcManager.session;!m||!m.peerConnection||G.peersToMonitor[m.consumerId]||G.addConnection({pc:m.peerConnection,peerId:m.consumerId,connectionId:m.id,remote:!1})})}),re(()=>{s=setInterval(oe,r.updateInterval),Y(),G.on("stats",V=>{try{const t=V.data.video.inbound[0];if(t===void 0)return;if(B=t.bitrate===0,!isNaN(t.bitrate)){const f=t.bitrate/1e3;S=S*.8+f*.2}v=t.packetsLost,z=t.nackCount,$=t.pliCount,A=t.firCount,F=t.packetsReceived;let m=t.totalProcessingDelay-p,x=t.framesReceived-U;E=1e3*m/x,U=t.framesReceived,p=t.totalProcessingDelay,l=v/(v+F)*100,j=t.freezeCount,o=t.totalFreezesDuration,e=t.framesDropped,b=t.framesPerSecond??0,W=t.frameHeight}catch(t){console.error(t)}})}),ie(()=>{clearInterval(s),cancelAnimationFrame(a)}),(V,t)=>(y(),g("div",Ne,[i("canvas",{ref_key:"canvasRef",ref:P,width:R.width,height:R.height},null,8,Fe)]))}}),Re=le(Ce,[["__scopeId","data-v-addc69db"]]),Pe=ue("v-banner-text"),$e={ref:"videoWidget",class:"video-widget"},De={key:1,class:"no-video-alert"},Me={key:2,class:"no-video-alert"},Te={key:3,class:"no-video-alert"},ze={class:"no-video-alert"},Ae={key:4,class:"no-video-alert"},Ue={class:"flex-wrap justify-center d-flex ga-5"},Be=te({__name:"VideoPlayer",props:{widget:{}},setup(R){de(o=>({"281c6376":n(a).options.videoFitStyle,"20fb88cc":B.value}));const O=ve(),r=ae(),P=me(),{namessAvailableAbstractedStreams:u}=ce(r),a=pe(R).widget,s=N(),S=N(),v=N(),F=N(!1);fe(()=>{const o={videoFitStyle:"cover",flipHorizontally:!1,flipVertically:!1,rotationAngle:0,statsForNerds:!1,internalStreamName:void 0};a.value.options=Object.assign({},o,a.value.options),s.value=a.value.options.internalStreamName});const p=I(()=>s.value?r.externalStreamId(s.value):void 0);L(()=>r.streamsCorrespondency,()=>{if(v.value=void 0,!s.value)return;const o=r.externalStreamId(s.value);if(!o)return;const e=r.streamsCorrespondency.find(b=>b.externalId===o);if(!e)return;const l=e.name;s.value!==l&&(s.value=l,a.value.options.internalStreamName=l)},{deep:!0});const z=setInterval(()=>{var o;if(a.value.options.internalStreamName===void 0&&!u.value.isEmpty()&&(a.value.options.internalStreamName=u.value[0],s.value=a.value.options.internalStreamName),p.value!==void 0){const e=r.getMediaStream(p.value);ye(e,v.value)||(v.value=e);const l=((o=r.getStreamData(p.value))==null?void 0:o.connected)??!1;l!==F.value&&(F.value=l)}if(!u.value.isEmpty()&&!u.value.includes(s.value)){if(r.lastRenamedStreamName!==""){s.value=r.lastRenamedStreamName;return}s.value=u.value[0]}},1e3);ge(()=>clearInterval(z)),L(s,()=>{a.value.options.internalStreamName=s.value,v.value=void 0}),L(v,()=>{!S.value||!v.value||(S.value.srcObject=v.value,S.value.play().then(()=>console.log("[VideoPlayer] Stream is playing")).catch(o=>{const e=`Failed to play stream. Reason: ${o}`;console.error(`[VideoPlayer] ${e}`)}))});const $=o=>{a.value.options.rotationAngle+=o},A=I(()=>`scale(${a.value.options.flipHorizontally?-1:1}, ${a.value.options.flipVertically?-1:1})`),U=I(()=>`rotate(${a.value.options.rotationAngle??0}deg)`),B=I(()=>`${A.value} ${U.value}`),E=I(()=>{var o;return p.value===void 0?"Unknown.":((o=r.getStreamData(p.value))==null?void 0:o.webRtcManager.signallerStatus)??"Unknown."}),j=I(()=>{var e;if(p.value===void 0)return"Unknown.";const o=r.availableIceIps;return!o.isEmpty()&&!o.find(l=>r.allowedIceIps.includes(l))?`Stream is coming from IPs [${o.join(", ")}], which are not in the list of allowed sources
      [${r.allowedIceIps.join(", ")}].\\n Please check your configuration.`:((e=r.getStreamData(p.value))==null?void 0:e.webRtcManager.streamStatus)??"Unknown."});return(o,e)=>(y(),g(_,null,[i("div",$e,[n(a).options.statsForNerds?(y(),Se(Re,{key:0,"stream-name":p.value},null,8,["stream-name"])):be("",!0),s.value===void 0?(y(),g("div",De,e[8]||(e[8]=[i("span",null,"No video stream selected.",-1)]))):!n(u).isEmpty()&&!n(u).includes(s.value)?(y(),g("div",Me,[i("p",null,'The selected stream "'+T(s.value)+'" is not available.',1),i("p",null,"Available ones are: "+T(n(u).map(l=>`"${l}"`).join(", "))+".",1),e[9]||(e[9]=i("br",null,null,-1)),e[10]||(e[10]=i("p",null," This can happen if you changed vehicles and the stream name in the new one is different from the former, or if the source is not available at all. ",-1)),e[11]||(e[11]=i("br",null,null,-1)),e[12]||(e[12]=i("p",null," Please open this video player configuration and select a new stream from the ones available, or check your source for issues. ",-1))])):F.value?(y(),g("div",Ae,e[17]||(e[17]=[i("p",null,"Loading stream...",-1)]))):(y(),g("div",Te,[i("div",ze,[i("p",null,[e[14]||(e[14]=i("span",{class:"text-xl font-bold"},"Server status: ",-1)),(y(!0),g(_,null,X(E.value.toString().split("\\n"),(l,b)=>(y(),g("span",{key:b},[C(T(l)+" ",1),e[13]||(e[13]=i("br",null,null,-1))]))),128))]),i("p",null,[e[16]||(e[16]=i("span",{class:"text-xl font-bold"},"Stream status: ",-1)),(y(!0),g(_,null,X(j.value.toString().split("\\n"),(l,b)=>(y(),g("span",{key:b},[C(T(l)+" ",1),e[15]||(e[15]=i("br",null,null,-1))]))),128))])])])),i("video",{id:"mainDisplayStream",ref_key:"videoElement",ref:S,muted:"",autoplay:"",playsinline:"",disablePictureInPicture:""}," Your browser does not support the video tag. ",512)],512),c(ke,{modelValue:n(P).widgetManagerVars(n(a).hash).configMenuOpen,"onUpdate:modelValue":e[7]||(e[7]=l=>n(P).widgetManagerVars(n(a).hash).configMenuOpen=l),width:"auto"},{default:k(()=>[c(Ve,{class:"pa-4 text-white",style:xe([{"border-radius":"15px"},n(O).globalGlassMenuStyles])},{default:k(()=>[c(he,{class:"text-center"},{default:k(()=>e[18]||(e[18]=[C("Video widget config")])),_:1}),c(we,{class:"flex flex-col gap-y-4"},{default:k(()=>[c(Z,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=l=>s.value=l),label:"Stream name",class:"my-3",items:n(u),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue","items"]),c(Z,{modelValue:n(a).options.videoFitStyle,"onUpdate:modelValue":e[1]||(e[1]=l=>n(a).options.videoFitStyle=l),label:"Fit style",class:"my-3",items:["cover","fill","contain"],"item-title":"style",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue"]),c(Pe,null,{default:k(()=>[C('Saved stream name: "'+T(n(a).options.internalStreamName)+'"',1)]),_:1}),c(J,{modelValue:n(a).options.flipHorizontally,"onUpdate:modelValue":e[2]||(e[2]=l=>n(a).options.flipHorizontally=l),class:"my-1",label:"Flip horizontally",color:n(a).options.flipHorizontally?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),c(J,{modelValue:n(a).options.flipVertically,"onUpdate:modelValue":e[3]||(e[3]=l=>n(a).options.flipVertically=l),class:"my-1",label:"Flip vertically",color:n(a).options.flipVertically?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),c(J,{modelValue:n(a).options.statsForNerds,"onUpdate:modelValue":e[4]||(e[4]=l=>n(a).options.statsForNerds=l),class:"my-1",label:"Stats for nerds",color:n(a).options.statsForNerds?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),i("div",Ue,[c(ee,{"prepend-icon":"mdi-file-rotate-left",variant:"outlined",onClick:e[5]||(e[5]=l=>$(-90))},{default:k(()=>e[19]||(e[19]=[C(" Rotate Left")])),_:1}),c(ee,{"prepend-icon":"mdi-file-rotate-right",variant:"outlined",onClick:e[6]||(e[6]=l=>$(90))},{default:k(()=>e[20]||(e[20]=[C(" Rotate Right")])),_:1})])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"])],64))}}),je=le(Be,[["__scopeId","data-v-f57695a6"]]);export{je as default};
