import{c as ee,af as te,K as ae,y as oe,ag as se,J as ne,r as p,ah as ie,ai as re,e as le,k as D,w,o as de,L as ue,aj as ce,ak as ve,al as me,D as fe,l as V,m as c,n as m,H as x,s as K,x as q,v as l,F as H,I,t as P,am as ge,O as h,a6 as $,Q as N,an as pe,N as he,ao as ye,a7 as U,W as Se,ap as be,_ as we}from"./index-CLy5JYB0.js";const xe={class:"text-xs text-white select-none scroll-text"},Ve={key:1,class:"w-16 text-justify text-slate-100"},ke={class:"flex justify-center w-6"},Me={class:"flex w-full justify-between items-center mt-4"},_e={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},Ce=ee({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(G){const{showDialog:y}=te(),R=ae(),f=oe(),n=se(),o=ne(G).miniWidget,a=p(),{namessAvailableAbstractedStreams:k}=ie(n),B=p(),{isOutside:A}=re(B),E=p(!1),S=p(!1),J=le({interval:100}),v=p(),W=p(0),i=p(),M=D(()=>i.value),O=()=>{R.videoLibraryMode="videos",R.videoLibraryVisibility=!0};w(()=>n.streamsCorrespondency,()=>v.value=void 0,{deep:!0}),de(async()=>{await j()}),ue(async()=>{Object.keys(o.value.options).length===0&&(o.value.options={internalStreamName:void 0}),a.value=o.value.options.internalStreamName,a.value&&(i.value=n.externalStreamId(a.value))}),w(a,()=>{o.value.options.internalStreamName=a.value,v.value=void 0}),w(()=>n.streamsCorrespondency,t=>{if(!i.value)return;const e=t.find(u=>u.externalId===i.value);e?a.value!==e.name&&(a.value=e.name):(a.value=void 0,i.value=void 0)},{deep:!0}),w(a,t=>{i.value=t?n.externalStreamId(t):void 0,o.value.options.internalStreamName=t,v.value=void 0});const j=async()=>{const e=(await n.videoStorage.keys()).filter(s=>n.isVideoFilename(s)),u=await n.tempVideoStorage.keys(),r=new Set;for(const s of u){if(s.includes("thumbnail_"))continue;const d=s.split("_");if(d.length<2)continue;const C=d[0],Z=parseInt(d[d.length-1],10);if(!isNaN(Z))try{const F=await n.tempVideoStorage.getItem(s);F&&F.size>0&&r.add(C)}catch(F){console.warn(`Failed to check chunk ${s}:`,F)}}const _=new Set;for(const s of e){const d=s.match(/#([a-f0-9]+)\./);d&&d[1]&&_.add(d[1])}const b=new Set;r.forEach(s=>b.add(s)),_.forEach(s=>{r.has(s)||b.add(s)}),W.value=b.size};function T(t){if(a.value=t,a.value===void 0){y({message:"No stream selected.",variant:"error"});return}if(k.value.includes(a.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw y({message:e,variant:"error"}),new Error(e)}const Q=async()=>{if(g.value){i.value&&n.stopRecording(i.value);return}if(!a.value){f.miniWidgetManagerVars(o.value.hash).configMenuOpen=!0;return}L()},L=()=>{var t;if(!i.value){y({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=n.getStreamData(i.value))!=null&&t.connected)){y({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}T(a.value),n.startRecording(i.value),f.miniWidgetManagerVars(o.value.hash).configMenuOpen=!1},g=D(()=>i.value?n.isRecording(i.value):!1),Y=D(()=>{var b,s,d,C;if(M.value===void 0)return"00:00:00";const t=(b=n.getStreamData(M.value))==null?void 0:b.timeRecordingStart;if(t===void 0)return"00:00:00";const e=ce({start:t,end:J.value}),u=((s=e.hours)==null?void 0:s.toFixed(0).length)===1?`0${e.hours}`:e.hours,r=((d=e.minutes)==null?void 0:d.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,_=((C=e.seconds)==null?void 0:C.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${u}:${r}:${_}`}),X=async t=>{T(t),v.value=void 0,S.value=!0;let e=0;const u=100,r=3e3;for(;S.value&&e<r;)S.value=v.value===void 0||!v.value.active,await be(u),e+=u;if(S.value){y({message:"Could not load media stream.",variant:"error"});return}o.value.options.internalStreamName=t};let z;return f.isRealMiniWidget(o.value.hash)&&(z=setInterval(()=>{if(o.value.options.internalStreamName===void 0&&!k.value.isEmpty()&&(o.value.options.internalStreamName=k.value[0],a.value=o.value.options.internalStreamName),M.value!==void 0){const t=n.getMediaStream(M.value);ve(t,v.value)||(v.value=t)}},1e3)),me(()=>clearInterval(z)),w(()=>E.value,async t=>{t===!1&&await j()}),w(g,()=>{if(!g.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(y({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const u=fe("FontAwesomeIcon");return c(),V(H,null,[m("div",{ref_key:"recorderWidget",ref:B,class:"flex justify-around px-2 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[m("div",{class:q([{"blob red w-5 opacity-100 rounded-sm":g.value,"opacity-30 bg-red-400":l(A)&&!g.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=r=>Q())},null,2),g.value?K("",!0):(c(),V(H,{key:0},[a.value?(c(),V("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=r=>l(f).miniWidgetManagerVars(l(o).hash).configMenuOpen=!0)},[m("div",xe,P(a.value),1)])):(c(),I(u,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)),g.value?(c(),V("div",Ve,P(Y.value),1)):K("",!0),m("div",ke,[x(ge,{vertical:"",class:"h-6 ml-1"}),W.value>0?(c(),I(pe,{key:0,color:"info",content:W.value,dot:l(A)||E.value,class:"cursor-pointer",onClick:O},{default:h(()=>[x($,{class:"w-6 h-6 ml-1 text-slate-100",onClick:O},{default:h(()=>e[4]||(e[4]=[N(" mdi-video-box ")])),_:1,__:[4]})]),_:1},8,["content","dot"])):(c(),I($,{key:1,class:"w-6 h-6 ml-1 text-slate-100 cursor-pointer",onClick:O},{default:h(()=>e[5]||(e[5]=[N(" mdi-video-box ")])),_:1,__:[5]}))])],512),x(Se,{modelValue:l(f).miniWidgetManagerVars(l(o).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=r=>l(f).miniWidgetManagerVars(l(o).hash).configMenuOpen=r),width:"auto"},{default:h(()=>[m("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:he(l(R).globalGlassMenuStyles)},[e[9]||(e[9]=m("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),x(ye,{"model-value":a.value,label:"Stream name",items:l(k),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":X},null,8,["model-value","items"]),m("div",Me,[x(U,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=r=>l(f).miniWidgetManagerVars(l(o).hash).configMenuOpen=!1)},{default:h(()=>e[6]||(e[6]=[N(" Close ")])),_:1,__:[6]}),x(U,{class:q(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":S.value}]),size:"large",onClick:L},{default:h(()=>[e[8]||(e[8]=m("span",null,"Record",-1)),S.value?(c(),I($,{key:0,class:"m-2 animate-spin"},{default:h(()=>e[7]||(e[7]=[N("mdi-loading")])),_:1,__:[7]})):(c(),V("div",_e))]),_:1,__:[8]},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),Ne=we(Ce,[["__scopeId","data-v-b4d025c1"]]);export{Ne as default};
