import{c as Z,aG as ee,K as te,y as ae,aH as se,J as oe,r as c,aI as ne,aJ as ie,e as re,k as R,w as v,o as le,L as de,aK as ue,aL as ce,aM as ve,D as me,l as m,m as i,n as g,H as x,s as E,x as U,v as r,N as f,Q as b,ag as _,F as z,I as F,t as H,aN as ge,aO as fe,O as pe,aP as ye,ai as q,W as xe,aQ as Se,_ as he}from"./index-Bts4qd0i.js";const we={key:1},be={class:"text-xs text-white select-none scroll-text"},Ve={key:3,class:"w-16 text-justify text-slate-100"},ke={key:4,class:"w-16 text-justify text-slate-100"},Me={class:"flex justify-center w-6"},_e={class:"flex w-full justify-between items-center mt-4"},Fe={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},Ce=Z({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(G){const{showDialog:S}=ee(),C=te(),p=ae(),s=se(),o=oe(G).miniWidget,a=c(),{namessAvailableAbstractedStreams:V}=ne(s),O=c(),{isOutside:W}=ie(O),D=c(!1),h=c(!1),J=re({interval:100}),u=c(),w=c(!1),I=c(0),n=c(),k=R(()=>n.value),N=()=>{C.videoLibraryMode="videos",C.videoLibraryVisibility=!0};v(()=>s.streamsCorrespondency,()=>u.value=void 0,{deep:!0}),le(async()=>{await M()}),de(async()=>{Object.keys(o.value.options).length===0&&(o.value.options={internalStreamName:void 0}),a.value=o.value.options.internalStreamName,a.value&&(n.value=s.externalStreamId(a.value))}),v(a,()=>{o.value.options.internalStreamName=a.value,u.value=void 0}),v(()=>s.streamsCorrespondency,t=>{if(!n.value)return;const e=t.find(l=>l.externalId===n.value);e?a.value!==e.name&&(a.value=e.name):(a.value=void 0,n.value=void 0)},{deep:!0}),v(a,t=>{n.value=t?s.externalStreamId(t):void 0,o.value.options.internalStreamName=t,u.value=void 0});const M=async()=>{const e=(await s.videoStorage.keys()).filter(d=>s.isVideoFilename(d)).length,l=Object.keys(s.keysFailedUnprocessedVideos).length;I.value=e+l};function B(t){if(a.value=t,a.value===void 0){S({message:"No stream selected.",variant:"error"});return}if(V.value.includes(a.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw S({message:e,variant:"error"}),new Error(e)}const K=async()=>{if(y.value){n.value&&s.stopRecording(n.value);return}if(!a.value){p.miniWidgetManagerVars(o.value.hash).configMenuOpen=!0;return}$()},$=()=>{var t;if(!n.value){S({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=s.getStreamData(n.value))!=null&&t.connected)){S({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}B(a.value),s.startRecording(n.value),p.miniWidgetManagerVars(o.value.hash).configMenuOpen=!1},y=R(()=>n.value?s.isRecording(n.value):!1),Q=R(()=>{var A,P,T,L;if(k.value===void 0)return"00:00:00";const t=(A=s.getStreamData(k.value))==null?void 0:A.timeRecordingStart;if(t===void 0)return"00:00:00";const e=ue({start:t,end:J.value}),l=((P=e.hours)==null?void 0:P.toFixed(0).length)===1?`0${e.hours}`:e.hours,d=((T=e.minutes)==null?void 0:T.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,X=((L=e.seconds)==null?void 0:L.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${l}:${d}:${X}`}),Y=async t=>{B(t),u.value=void 0,h.value=!0;let e=0;const l=100,d=3e3;for(;h.value&&e<d;)h.value=u.value===void 0||!u.value.active,await Se(l),e+=l;if(h.value){S({message:"Could not load media stream.",variant:"error"});return}o.value.options.internalStreamName=t};let j;return p.isRealMiniWidget(o.value.hash)&&(j=setInterval(()=>{if(o.value.options.internalStreamName===void 0&&!V.value.isEmpty()&&(o.value.options.internalStreamName=V.value[0],a.value=o.value.options.internalStreamName),k.value!==void 0){const t=s.getMediaStream(k.value);ce(t,u.value)||(u.value=t)}},1e3)),ve(()=>clearInterval(j)),v(()=>s.areThereVideosProcessing,t=>{w.value=t,M()}),v(()=>s.keysFailedUnprocessedVideos,()=>M()),v(()=>D.value,async t=>{t===!1&&await M()}),v(y,()=>{if(!y.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(S({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const l=me("FontAwesomeIcon");return i(),m(z,null,[g("div",{ref_key:"recorderWidget",ref:O,class:"flex justify-around px-2 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[w.value?(i(),m("div",we,[x(_,{class:"w-6 h-6 animate-spin",color:"white"},{default:f(()=>e[4]||(e[4]=[b("mdi-loading")])),_:1,__:[4]})])):(i(),m("div",{key:0,class:U([{"blob red w-5 opacity-100 rounded-sm":y.value,"opacity-30 bg-red-400":r(W)&&!y.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=d=>K())},null,2)),!y.value&&!w.value?(i(),m(z,{key:2},[a.value?(i(),m("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=d=>r(p).miniWidgetManagerVars(r(o).hash).configMenuOpen=!0)},[g("div",be,H(a.value),1)])):(i(),F(l,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)):E("",!0),y.value&&!w.value?(i(),m("div",Ve,H(Q.value),1)):w.value?(i(),m("div",ke,e[5]||(e[5]=[g("div",{class:"text-xs text-center text-white select-none flex-nowrap"},"Processing video...",-1)]))):E("",!0),g("div",Me,[x(ge,{vertical:"",class:"h-6 ml-1"}),I.value>0?(i(),F(fe,{key:0,color:"info",content:I.value,dot:r(W)||D.value,class:"cursor-pointer",onClick:N},{default:f(()=>[x(_,{class:"w-6 h-6 ml-1 text-slate-100",onClick:N},{default:f(()=>e[6]||(e[6]=[b(" mdi-video-box ")])),_:1,__:[6]})]),_:1},8,["content","dot"])):(i(),F(_,{key:1,class:"w-6 h-6 ml-1 text-slate-100 cursor-pointer",onClick:N},{default:f(()=>e[7]||(e[7]=[b(" mdi-video-box ")])),_:1,__:[7]}))])],512),x(xe,{modelValue:r(p).miniWidgetManagerVars(r(o).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=d=>r(p).miniWidgetManagerVars(r(o).hash).configMenuOpen=d),width:"auto"},{default:f(()=>[g("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:pe(r(C).globalGlassMenuStyles)},[e[11]||(e[11]=g("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),x(ye,{"model-value":a.value,label:"Stream name",items:r(V),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":Y},null,8,["model-value","items"]),g("div",_e,[x(q,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=d=>r(p).miniWidgetManagerVars(r(o).hash).configMenuOpen=!1)},{default:f(()=>e[8]||(e[8]=[b(" Close ")])),_:1,__:[8]}),x(q,{class:U(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":h.value}]),size:"large",onClick:$},{default:f(()=>[e[10]||(e[10]=g("span",null,"Record",-1)),h.value?(i(),F(_,{key:0,class:"m-2 animate-spin"},{default:f(()=>e[9]||(e[9]=[b("mdi-loading")])),_:1,__:[9]})):(i(),m("div",Fe))]),_:1,__:[10]},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),Re=he(Ce,[["__scopeId","data-v-8d57dcfe"]]);export{Re as default};
