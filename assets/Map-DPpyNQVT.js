import{bF as Ve,bG as $e,bH as Pe,bI as q,f as _e,bJ as Me,bK as Be,bL as Fe,c as Ue,bv as Re,J as Xe,K as We,a8 as Ye,u as Ze,ak as Ge,r as m,k as w,M as ke,Y as we,L as qe,bM as u,j as Ke,w as y,o as je,bN as f,ae as Je,bO as Qe,aI as et,bP as tt,bQ as Te,aF as at,y as ot,l as S,m as se,n as F,H as I,N as O,I as U,a6 as K,a0 as j,q as r,au as H,s as N,a1 as J,v as nt,O as Q,V as lt,P as it,Q as st,R as rt,a5 as ut,W as ct,bR as dt,F as vt,z as mt,B as ft,E as pt,bS as re,_ as gt}from"./index--yn_uFz7.js";function Ie(p,x){if(p==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var l in x)Object.prototype.hasOwnProperty.call(x,l)&&(p[l]=x[l]);return p}function ht(p){return Ie({},p)}var Ce=1440,bt=2520,ue=43200,yt=86400;function xt(p,x,l){var P,_;Ve(2,arguments);var i=Fe(),n=(P=(_=l==null?void 0:l.locale)!==null&&_!==void 0?_:i.locale)!==null&&P!==void 0?P:$e;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var a=Pe(p,x);if(isNaN(a))throw new RangeError("Invalid time value");var s=Ie(ht(l),{addSuffix:!!(l!=null&&l.addSuffix),comparison:a}),g,d;a>0?(g=q(x),d=q(p)):(g=q(p),d=q(x));var T=_e(d,g),C=(Me(d)-Me(g))/1e3,c=Math.round((T-C)/60),V;if(c<2)return l!=null&&l.includeSeconds?T<5?n.formatDistance("lessThanXSeconds",5,s):T<10?n.formatDistance("lessThanXSeconds",10,s):T<20?n.formatDistance("lessThanXSeconds",20,s):T<40?n.formatDistance("halfAMinute",0,s):T<60?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",1,s):c===0?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",c,s);if(c<45)return n.formatDistance("xMinutes",c,s);if(c<90)return n.formatDistance("aboutXHours",1,s);if(c<Ce){var R=Math.round(c/60);return n.formatDistance("aboutXHours",R,s)}else{if(c<bt)return n.formatDistance("xDays",1,s);if(c<ue){var X=Math.round(c/Ce);return n.formatDistance("xDays",X,s)}else if(c<yt)return V=Math.round(c/ue),n.formatDistance("aboutXMonths",V,s)}if(V=Be(d,g),V<12){var ee=Math.round(c/ue);return n.formatDistance("xMonths",ee,s)}else{var W=V%12,A=Math.floor(V/12);return W<3?n.formatDistance("aboutXYears",A,s):W<9?n.formatDistance("overXYears",A,s):n.formatDistance("almostXYears",A+1,s)}}function Mt(p,x){return Ve(1,arguments),xt(p,Date.now(),x)}const kt=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,wt=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,Tt=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,Ct=["id"],Vt=Ue({__name:"Map",props:{widget:{}},setup(p){var xe;Re(e=>({a9c9f918:Le.value}));const x=p,l=Xe(x).widget,P=We(),{showDialog:_}=Ye(),i=Ze(),n=Ge(),a=m(),s=m(n.defaultMapZoom),g=m(n.defaultMapCenter),d=m(),T=w(()=>`map-${l.value.hash}`),C=m(!1);ke.registerUsage(we.latitude),ke.registerUsage(we.longitude),qe(()=>{Object.keys(l.value.options).length===0&&(l.value.options={showVehiclePath:!0}),h.enableAutoUpdate()});const c=u.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),V=u.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),R=u.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),X=u.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),ee={OpenStreetMap:c,"Esri World Imagery":V},W={Seamarks:R,"Marine Profile":X},A=m(),ce=Ke(A),de=u.control.zoom({position:"bottomright"}),ve=u.control.layers(ee,W);y(C,()=>{a.value!==void 0&&(C.value?(a.value.addControl(de),a.value.addControl(ve)):(a.value.removeControl(de),a.value.removeControl(ve)))}),y(ce,()=>{C.value=ce.value}),je(async()=>{a.value=u.map(T.value,{layers:[c,V,R,X],attributionControl:!1}).setView(g.value,s.value),a.value.removeControl(a.value.zoomControl),a.value.on("moveend",()=>{if(a.value===void 0)return;let{lat:e,lng:t}=a.value.getCenter();e&&t&&(g.value=[e,t])}),a.value.on("zoomend",()=>{var e;a.value!==void 0&&(s.value=((e=a.value)==null?void 0:e.getZoom())??g.value)}),a.value.on("click",()=>{a.value!==void 0&&a.value.on("click",pe)}),a.value.on("contextmenu",()=>{he()}),h.enableAutoUpdate(),window.addEventListener("keydown",be),b.value?h.goToTarget(f.VEHICLE):h.goToTarget(f.HOME)}),Je(()=>{h.disableAutoUpdate(),window.removeEventListener("keydown",be),a.value&&(a.value.off("click",pe),a.value.off("contextmenu"))}),y(g,(e,t)=>{var o,v,k;e.toString()!==t.toString()&&((o=a.value)==null||o.panTo(e),(k=(v=L.value)==null?void 0:v.getTooltip())==null||k.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),y(a,(e,t)=>{a.value!==void 0&&(e==null?void 0:e.options)===void 0&&(a.value=t)}),y(s,(e,t)=>{var o;e!==t&&((o=a.value)==null||o.setZoom(s.value))}),y(x.widget,()=>{var e;(e=a.value)==null||e.invalidateSize()});const z=m(void 0),h=new Qe(e=>z.value=e,e=>g.value=e);h.setTrackableTarget(f.VEHICLE,()=>b.value),h.setTrackableTarget(f.HOME,()=>d.value);const b=w(()=>i.coordinates.latitude?[i.coordinates.latitude,i.coordinates.longitude]:void 0),te=w(()=>{var e;return i.attitude.yaw?et((e=i.attitude)==null?void 0:e.yaw):0}),me=w(()=>{const e=i.lastHeartbeat;return e?`${Mt(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Ee}=tt(b);(xe=navigator==null?void 0:navigator.geolocation)==null||xe.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let fe=!0;y([d,a],async()=>{d.value===g.value||!a.value||!fe||(h.goToTarget(f.HOME),fe=!1)});const E=m();y(i.coordinates,()=>{if(!(!a.value||!b.value)){if(E.value===void 0){let e=Tt;i.vehicleType===Te.MAV_TYPE_SURFACE_BOAT?e=kt:i.vehicleType===Te.MAV_TYPE_SUBMARINE&&(e=wt);const t=u.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});E.value=u.marker(b.value,{icon:t});const o=u.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});E.value.bindTooltip(o),a.value.addLayer(E.value)}E.value.setLatLng(b.value)}}),y(b,(e,t)=>{z.value===f.VEHICLE||t!==void 0||h.follow(f.VEHICLE)}),y([b,te,me,()=>i.isArmed],()=>{var t,o,v,k,M;if(E.value===void 0)return;(k=E.value.getTooltip())==null||k.setContent(`
    <p>Coordinates: ${(t=b.value)==null?void 0:t[0].toFixed(6)}, ${(o=b.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((v=i.velocity.ground)==null?void 0:v.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${te.value.toFixed(2)}°</p>
    <p>${i.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${me.value}</p>
  `);const e=(M=E.value.getElement())==null?void 0:M.querySelector("img");e&&(e.style.transform=`rotate(${te.value}deg)`)});const L=m();y(d,()=>{if(a.value===void 0)return;const e=d.value;if(e!==void 0){if(L.value===void 0){L.value=u.marker(e);const t=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});L.value.setIcon(t);const o=u.tooltip({content:"No data available",className:"waypoint-tooltip"});L.value.bindTooltip(o),a.value.addLayer(L.value)}L.value.setLatLng(d.value)}});const ae=m();y(n.currentPlanningWaypoints,e=>{if(a.value!==void 0){if(ae.value===void 0){const t=e.map(o=>o.coordinates);ae.value=u.polyline(t,{color:"#358AC3"}).addTo(a.value)}ae.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,o)=>{var M;const v=u.marker(t.coordinates),k=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${o}`});v.setIcon(k),(M=a.value)==null||M.addLayer(v)})}});const oe=m();y(Ee,e=>{if(a.value===void 0||e===void 0)return;oe.value===void 0&&(oe.value=u.polyline([],{color:"#ffff00"}).addTo(a.value));const t=e.filter(o=>o.snapshot!==void 0).map(o=>o.snapshot);oe.value.setLatLngs(t)});const Y=m(!1),$=m(null),Z=at({top:"0px",left:"0px"}),D=m(),pe=e=>{var t,o,v,k;if(D.value!==void 0&&a.value!==void 0&&((t=D.value)==null||t.removeFrom(a.value)),((o=e==null?void 0:e.latlng)==null?void 0:o.lat)!=null&&((v=e==null?void 0:e.latlng)==null?void 0:v.lng)!=null){$.value=[e.latlng.lat,e.latlng.lng],Y.value=!0;const M=(k=a.value)==null?void 0:k.getContainer();if(M){const{x:le,y:ie}=M.getBoundingClientRect();Z.left=`${e.originalEvent.clientX-le}px`,Z.top=`${e.originalEvent.clientY-ie}px`}}else console.error("Invalid event structure:",e);if(a.value!==void 0){D.value=u.marker($.value);const M=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});D.value.setIcon(M),a.value.addLayer(D.value)}},ge=e=>{switch(e){case"goto":if($.value){const M=i.coordinates.altitude??0,le=$.value[0],ie=$.value[1];mt(async()=>{try{await i.goTo(0,0,0,0,le,ie,M)}catch(ze){re({message:ze,variant:"error"})}},{command:"GoTo"},ft(pt.GOTO))}break;case"set-default-map-position":n.setDefaultMapPosition(g.value,s.value);break;default:console.warn("Unknown menu option selected:",e)}Y.value=!1},he=()=>{Y.value=!1,$.value=null,a.value!==void 0&&D.value!==void 0&&a.value.removeLayer(D.value)},be=e=>{e.key==="Escape"&&he()},G=m(!1),ne=m(0),Se=async()=>{for(G.value=!0,ne.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async t=>{ne.value=t};try{(await i.fetchMission(e)).forEach(o=>{n.currentPlanningWaypoints.push(o)}),re({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(t){_({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{G.value=!1}},Oe=async()=>{try{await i.startMission()}catch{re({message:"Failed to start mission.",variant:"error"})}},B=ot(),Le=w(()=>`${Math.max(-B.widgetClearanceForVisibleArea(l.value).bottom,0)}px`),ye=w(()=>`${Math.max(-B.widgetClearanceForVisibleArea(l.value).top,0)}px`),De=w(()=>i.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),He=w(()=>i.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),Ne=w(()=>d.value===void 0?"Cannot center map on home (home position undefined).":z.value===f.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Ae=w(()=>i.isVehicleOnline?b.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":z.value===f.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline).");return(e,t)=>(S(),se(vt,null,[F("div",{ref_key:"mapBase",ref:A,class:nt(["page-base",r(B).editingMode?"pointer-events-none":"pointer-events-auto"])},[F("div",{id:T.value,ref_key:"map",ref:a,class:"map"},[I(J,{location:"top",text:Ne.value},{activator:O(({props:o})=>[C.value?(S(),U(K,j({key:0},o,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"],color:z.value==r(f).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:t[0]||(t[0]=H(v=>r(h).goToTarget(r(f).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=H(v=>r(h).follow(r(f).HOME),["stop"]))}),null,16,["class","color","disabled"])):N("",!0)]),_:1},8,["text"]),I(J,{location:"top",text:Ae.value},{activator:O(({props:o})=>[C.value?(S(),U(K,j({key:0},o,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50",b.value?"":"active-events-on-disabled"],color:z.value==r(f).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!b.value,onClick:t[2]||(t[2]=H(v=>r(h).goToTarget(r(f).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=H(v=>r(h).follow(r(f).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):N("",!0)]),_:1},8,["text"]),I(J,{location:"top",text:De.value},{activator:O(({props:o})=>[C.value?(S(),U(K,j({key:0},o,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50",r(i).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(i).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:H(Se,["stop"])}),null,16,["class","disabled"])):N("",!0)]),_:1},8,["text"]),I(J,{location:"top",text:He.value},{activator:O(({props:o})=>[C.value?(S(),U(K,j({key:0},o,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50",r(i).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(i).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:H(Oe,["stop"])}),null,16,["class","disabled"])):N("",!0)]),_:1},8,["text"])],8,Ct)],2),Y.value?(S(),se("div",{key:0,class:"context-menu",style:Q({top:Z.top,left:Z.left})},[F("ul",{onClick:t[6]||(t[6]=H(()=>{},["stop"]))},[F("li",{onClick:t[4]||(t[4]=o=>ge("goto"))},"GoTo"),F("li",{onClick:t[5]||(t[5]=o=>ge("set-default-map-position"))},"Set default map position")])],4)):N("",!0),I(ct,{modelValue:r(B).widgetManagerVars(r(l).hash).configMenuOpen,"onUpdate:modelValue":t[8]||(t[8]=o=>r(B).widgetManagerVars(r(l).hash).configMenuOpen=o),width:"auto"},{default:O(()=>[I(lt,{class:"pa-2",style:Q(r(P).globalGlassMenuStyles)},{default:O(()=>[I(it,{class:"text-center"},{default:O(()=>t[9]||(t[9]=[st("Map widget settings")])),_:1}),I(rt,null,{default:O(()=>[I(ut,{modelValue:r(l).options.showVehiclePath,"onUpdate:modelValue":t[7]||(t[7]=o=>r(l).options.showVehiclePath=o),class:"my-1",label:"Show vehicle path",color:r(l).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),G.value?(S(),U(dt,{key:1,"model-value":ne.value,height:"10",absolute:"",bottom:"",color:"white",style:Q(`top: ${ye.value}`)},null,8,["model-value","style"])):N("",!0),G.value?(S(),se("p",{key:2,style:Q({top:ye.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):N("",!0)],64))}}),Et=gt(Vt,[["__scopeId","data-v-9b394d15"]]);export{Et as default};
